<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
<meta http-equiv="x-ua-compatible" content="ie=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

<meta property="og:title" content="Part 7 - Créer une interface" />
<meta property="og:description" content="Avec chaque chapitre notre jeu est un peu plus jouable mais avant de progresser sur le gameplay, nous devrions prendre un moment pour nous concentrer sur l&rsquo;aspect esthétique. Contrairement à ce que les traditionalistes du roguelike pourraient vous dire, une bonne UI est pratique.
Commençons par la section sur l&rsquo;HP. Avec relativement peu de code nous pouvons ajouter une petite barre de vie qui nous dira combien il reste de santé au joueur avant de mourir." />
<meta property="og:type" content="article" />
<meta property="og:url" content="/tutoriels/tcod/part-7/" />
<meta property="article:published_time" content="2019-03-30T09:33:53-07:00"/>
<meta property="article:modified_time" content="2019-03-30T09:33:53-07:00"/>

<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Part 7 - Créer une interface"/>
<meta name="twitter:description" content="Avec chaque chapitre notre jeu est un peu plus jouable mais avant de progresser sur le gameplay, nous devrions prendre un moment pour nous concentrer sur l&rsquo;aspect esthétique. Contrairement à ce que les traditionalistes du roguelike pourraient vous dire, une bonne UI est pratique.
Commençons par la section sur l&rsquo;HP. Avec relativement peu de code nous pouvons ajouter une petite barre de vie qui nous dira combien il reste de santé au joueur avant de mourir."/>



    <link rel="canonical" href="/tutoriels/tcod/part-7/">

    <title>
      
        Part 7 - Créer une interface | Tutoriel Roguelike
      
    </title>

    
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css" integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO" crossorigin="anonymous">
    <link href="/css/style.css" rel="stylesheet">

    

    

    
  </head>
  <body>
    
      

<header class="blog-header">
    <nav class="navbar navbar-expand-md navbar-dark bg-dark">
        <a class="navbar-brand" href="/">
            Tutoriel Roguelike
        </a>
        <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false"
            aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse justify-content-between" id="navbarNav">
            <ul class="navbar-nav">
                
                
                <li class="nav-item ">
                    
                        <a class="nav-link" href="/">Home</a>
                    
                </li>
                
                <li class="nav-item ">
                    
                        <a class="nav-link" href="/tutoriels/tcod/">Tutoriel TCOD</a>
                    
                </li>
                
                <li class="nav-item ">
                    
                        <a class="nav-link" href="/about/">A propos</a>
                    
                </li>
                
            </ul>
            
        </div>
    </nav>
</header>

    

    
    <div class="container">
      <div class="row">
        <div class="col-12 col-lg-8 blog-main">

          

<header>
    <h2 class="blog-post-title">
    <a class="text-dark" href="/tutoriels/tcod/part-7/">Part 7 - Créer une interface</a>
</h2>

    


<div class="blog-post-date text-secondary">
    
        <time datetime="2019-03-30">Mar 30, 2019</time>
    
    
</div>

    
    
    <hr>
</header>
<article class="blog-post">
    <p>Avec chaque chapitre notre jeu est un peu plus jouable mais avant de progresser
sur le gameplay, nous devrions prendre un moment pour nous concentrer sur
l&rsquo;aspect <em>esthétique</em>. Contrairement à ce que les traditionalistes du roguelike
pourraient vous dire, une bonne UI est pratique.</p>

<p>Commençons par la section sur l&rsquo;HP. Avec relativement peu de code nous pouvons
ajouter une petite barre de vie qui nous dira combien il reste de santé au
joueur avant de mourir. Commençons par ajouter quelques variables utiles dans
<code>engine.py</code></p>

<div>
  <button class="btn btn-primary data-toggle-tab active" data-toggle-tab="diff">
    Diff
  </button>
  <button class="btn btn-secondary data-toggle-tab" data-toggle-tab="original">
    Original
  </button>

   <div class="data-pane active" data-pane="diff">
   <div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-diff" data-lang="diff">    ...
    screen_height = 50

<span style="color:#a6e22e">+   bar_width = 20
</span><span style="color:#a6e22e">+   panel_height = 7
</span><span style="color:#a6e22e">+   panel_y = screen_height - panel_height
</span><span style="color:#a6e22e"></span>
    map_width = 80
<span style="color:#f92672">-   map_height = 45
</span><span style="color:#f92672"></span><span style="color:#a6e22e">+   map_height = 43
</span><span style="color:#a6e22e"></span>    ...
    con = libtcod.console_new(screen_width, screen_height)
<span style="color:#a6e22e">+   panel = libtcod.console_new(screen_width, panel_height)
</span></code></pre></div>

</div>
<div class="data-pane" data-pane="original">
  
<pre>    ...
    screen_height = 50

    <span class="new-text">bar_width = 20
    panel_height = 7
    panel_y = screen_height - panel_height</span>

    map_width = 80
    <span class="crossed-out-text">map_height = 45</span>
    <span class="new-text">map_height = 43</span>
    ...
    con = libtcod.console_new(screen_width, screen_height)
    <span class="new-text">panel = libtcod.console_new(screen_width, panel_height)</span></pre>

</div>

</div>


<p>Nous créons une nouvelle console, <code>panel</code>, qui contiendra notre barre de vie
et le journal des messages. Nous avons aussi modifié la hauteur de la carte
afin de laisser un peu de place à notre barre de vie et notre futur journal de
message.</p>

<p>Maintenant il nous faut une faut une fonction qui dessine la barre de vie et
n&rsquo;importe quelle barre qu&rsquo;on puisse souhaiter. Vous pouvez ajouter une barre
de Mana ou de Stamina plus tard si vous le souhaitez aussi il est préférable
de la rendre la plus réutilisable possible. Ajoutez la suite à
<code>render_functions.py</code>, juste en dessous de l&rsquo;enum <code>RenderOrder</code> mais au dessus
de <code>render_all</code>.</p>

<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-py3" data-lang="py3"><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">render_bar</span>(panel, x, y, total_width, name, value, maximum, bar_color, back_color):
    bar_width <span style="color:#f92672">=</span> int(float(value) <span style="color:#f92672">/</span> maximum <span style="color:#f92672">*</span> total_width)

    libtcod<span style="color:#f92672">.</span>console_set_default_background(panel, back_color)
    libtcod<span style="color:#f92672">.</span>console_rect(panel, x, y, total_width, <span style="color:#ae81ff">1</span>, <span style="color:#66d9ef">False</span>, libtcod<span style="color:#f92672">.</span>BKGND_SCREEN)

    libtcod<span style="color:#f92672">.</span>console_set_default_background(panel, bar_color)
    <span style="color:#66d9ef">if</span> bar_width <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">0</span>:
        libtcod<span style="color:#f92672">.</span>console_rect(panel, x, y, bar_width, <span style="color:#ae81ff">1</span>, <span style="color:#66d9ef">False</span>, libtcod<span style="color:#f92672">.</span>BKGND_SCREEN)

    libtcod<span style="color:#f92672">.</span>console_set_default_foreground(panel, libtcod<span style="color:#f92672">.</span>white)
    libtcod<span style="color:#f92672">.</span>console_print_ex(panel, int(x <span style="color:#f92672">+</span> total_width <span style="color:#f92672">/</span> <span style="color:#ae81ff">2</span>), y, libtcod<span style="color:#f92672">.</span>BKGND_NONE, libtcod<span style="color:#f92672">.</span>CENTER,
                             <span style="color:#e6db74">&#39;</span><span style="color:#e6db74">{0}</span><span style="color:#e6db74">: </span><span style="color:#e6db74">{1}</span><span style="color:#e6db74">/</span><span style="color:#e6db74">{2}</span><span style="color:#e6db74">&#39;</span><span style="color:#f92672">.</span>format(name, value, maximum))</code></pre></div>

<p>Maintenant utilisons cette fonction dans <code>render_all</code>. Retirez l&rsquo;indication de
HP qu&rsquo;on a ajouté plus tôt et ajoutez le code pour le panneau de statistiques
à la fin de la fonction.</p>

<div>
  <button class="btn btn-primary data-toggle-tab active" data-toggle-tab="diff">
    Diff
  </button>
  <button class="btn btn-secondary data-toggle-tab" data-toggle-tab="original">
    Original
  </button>

   <div class="data-pane active" data-pane="diff">
   <div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-diff" data-lang="diff"><span style="color:#f92672">-def render_all(con, entities, player, game_map, fov_map, fov_recompute, screen_width, screen_height, colors):
</span><span style="color:#f92672"></span><span style="color:#a6e22e">+def render_all(con, panel, entities, player, game_map, fov_map, fov_recompute, screen_width, screen_height, bar_width,
</span><span style="color:#a6e22e">+              panel_height, panel_y, colors):
</span><span style="color:#a6e22e"></span>            ...
<span style="color:#f92672">-   libtcod.console_set_default_foreground(con, libtcod.white)
</span><span style="color:#f92672">-   libtcod.console_print_ex(con, 1, screen_height - 2, libtcod.BKGND_NONE, libtcod.LEFT,
</span><span style="color:#f92672">-                            &#39;HP: {0:02}/{1:02}&#39;.format(player.fighter.hp, player.fighter.max_hp))
</span><span style="color:#f92672"></span>
    libtcod.console_blit(con, 0, 0, screen_width, screen_height, 0, 0, 0)

<span style="color:#a6e22e">+   libtcod.console_set_default_background(panel, libtcod.black)
</span><span style="color:#a6e22e">+   libtcod.console_clear(panel)
</span><span style="color:#a6e22e">+
</span><span style="color:#a6e22e">+   render_bar(panel, 1, 1, bar_width, &#39;HP&#39;, player.fighter.hp, player.fighter.max_hp,
</span><span style="color:#a6e22e">+              libtcod.light_red, libtcod.darker_red)
</span><span style="color:#a6e22e">+
</span><span style="color:#a6e22e">+   libtcod.console_blit(panel, 0, 0, screen_width, panel_height, 0, 0, panel_y)
</span></code></pre></div>

</div>
<div class="data-pane" data-pane="original">
  
<pre><span class="crossed-out-text">def render_all(con, entities, player, game_map, fov_map, fov_recompute, screen_width, screen_height, colors):</span>
<span class="new-text">def render_all(con, panel, entities, player, game_map, fov_map, fov_recompute, screen_width, screen_height, bar_width,
               panel_height, panel_y, colors):</span>
            ...
    <span class="crossed-out-text">libtcod.console_set_default_foreground(con, libtcod.white)</span>
    <span class="crossed-out-text">libtcod.console_print_ex(con, 1, screen_height - 2, libtcod.BKGND_NONE, libtcod.LEFT,</span>
                             <span class="crossed-out-text">'HP: {0:02}/{1:02}'.format(player.fighter.hp, player.fighter.max_hp))</span>

    libtcod.console_blit(con, 0, 0, screen_width, screen_height, 0, 0, 0)

    <span class="new-text">libtcod.console_set_default_background(panel, libtcod.black)
    libtcod.console_clear(panel)

    render_bar(panel, 1, 1, bar_width, 'HP', player.fighter.hp, player.fighter.max_hp,
               libtcod.light_red, libtcod.darker_red)

    libtcod.console_blit(panel, 0, 0, screen_width, panel_height, 0, 0, panel_y)</span></pre>

</div>

</div>


<p>Ajoutez l&rsquo;appel à <code>render_all</code> dans <code>engine.py</code>.</p>

<div>
  <button class="btn btn-primary data-toggle-tab active" data-toggle-tab="diff">
    Diff
  </button>
  <button class="btn btn-secondary data-toggle-tab" data-toggle-tab="original">
    Original
  </button>

   <div class="data-pane active" data-pane="diff">
   <div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-diff" data-lang="diff"><span style="color:#f92672">-       render_all(con, entities, player, game_map, fov_map, fov_recompute, screen_width, screen_height, colors)
</span><span style="color:#f92672"></span><span style="color:#a6e22e">+       render_all(con, panel, entities, player, game_map, fov_map, fov_recompute, screen_width, screen_height,
</span><span style="color:#a6e22e">+                  bar_width, panel_height, panel_y, colors)
</span></code></pre></div>

</div>
<div class="data-pane" data-pane="original">
  
<pre>        <span class="crossed-out-text">render_all(con, entities, player, game_map, fov_map, fov_recompute, screen_width, screen_height, colors)</span>
        <span class="new-text">render_all(con, panel, entities, player, game_map, fov_map, fov_recompute, screen_width, screen_height,
                   bar_width, panel_height, panel_y, colors)</span></pre>

</div>

</div>


<p>Maintenant on a une jolie barre de vie en bas de l&rsquo;écran. Elle va décroître
quand le joueur perd des HP et croître quand on se soigne (ça arrive au prochain
chapitre).</p>

<p>Continuons d&rsquo;avancer et créons un journal de messages. Ajouter les variables
suivantes à <code>engine.py</code> :</p>

<div>
  <button class="btn btn-primary data-toggle-tab active" data-toggle-tab="diff">
    Diff
  </button>
  <button class="btn btn-secondary data-toggle-tab" data-toggle-tab="original">
    Original
  </button>

   <div class="data-pane active" data-pane="diff">
   <div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-diff" data-lang="diff">    ...
    panel_y = screen_height - panel_height

<span style="color:#a6e22e">+   message_x = bar_width + 2
</span><span style="color:#a6e22e">+   message_width = screen_width - bar_width - 2
</span><span style="color:#a6e22e">+   message_height = panel_height - 1
</span><span style="color:#a6e22e"></span>
    map_width = 80
    ...
</code></pre></div>

</div>
<div class="data-pane" data-pane="original">
  
<pre>    ...
    panel_y = screen_height - panel_height

    <span class="new-text">message_x = bar_width + 2
    message_width = screen_width - bar_width - 2
    message_height = panel_height - 1</span>

    map_width = 80
    ...</pre>

</div>

</div>


<p>Pour implémenter un journal de message, nous avons besoin de deux classes :
une pour le journal et une pour les messages qu&rsquo;il contient. Commencez par
créer un nouveau fichier appelé <code>game_messages.py</code>. Ajoutez-y le code suivant :</p>

<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-py3" data-lang="py3"><span style="color:#f92672">import</span> tcod <span style="color:#66d9ef">as</span> libtcod

<span style="color:#f92672">import</span> textwrap


<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Message</span>:
    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">__init__</span>(self, text, color<span style="color:#f92672">=</span>libtcod<span style="color:#f92672">.</span>white):
        self<span style="color:#f92672">.</span>text <span style="color:#f92672">=</span> text
        self<span style="color:#f92672">.</span>color <span style="color:#f92672">=</span> color


<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">MessageLog</span>:
    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">__init__</span>(self, x, width, height):
        self<span style="color:#f92672">.</span>messages <span style="color:#f92672">=</span> []
        self<span style="color:#f92672">.</span>x <span style="color:#f92672">=</span> x
        self<span style="color:#f92672">.</span>width <span style="color:#f92672">=</span> width
        self<span style="color:#f92672">.</span>height <span style="color:#f92672">=</span> height

    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">add_message</span>(self, message):
        <span style="color:#75715e"># Split the message if necessary, among multiple lines</span>
        new_msg_lines <span style="color:#f92672">=</span> textwrap<span style="color:#f92672">.</span>wrap(message<span style="color:#f92672">.</span>text, self<span style="color:#f92672">.</span>width)

        <span style="color:#66d9ef">for</span> line <span style="color:#f92672">in</span> new_msg_lines:
            <span style="color:#75715e"># If the buffer is full, remove the first line to make room for the new one</span>
            <span style="color:#66d9ef">if</span> len(self<span style="color:#f92672">.</span>messages) <span style="color:#f92672">==</span> self<span style="color:#f92672">.</span>height:
                <span style="color:#66d9ef">del</span> self<span style="color:#f92672">.</span>messages[<span style="color:#ae81ff">0</span>]

            <span style="color:#75715e"># Add the new line as a Message object, with the text and the color</span>
            self<span style="color:#f92672">.</span>messages<span style="color:#f92672">.</span>append(Message(line, message<span style="color:#f92672">.</span>color))</code></pre></div>

<p>Cela fait beaucoup aussi examinons en détail.</p>

<p><code>Message</code> est plutôt simple. On enregistre le message et la couleur associée.
Vous pouvez décider de ne pas passer de couleur, auquel cas, le blanc est
utilisé par défaut.</p>

<p>La classe <code>MessageLog</code> est la plus intéressante. Elle conserve une liste de
messages (de la classe <code>Message</code>), conserve les coordonnées en x (par commodité)
et sans hauteur et largeur. Hauteur et largeur sont pratiques pour savoir
quand couper le message du haut (les messages vont &ldquo;défiler&rdquo; avec l&rsquo;arrivée de
nouveaux messages).</p>

<p>Dans la méthode <code>add_message</code>, on sépare le texte des messages en de multiples
lignes si c&rsquo;est nécessaire, en utilisant la fonction <code>textwrap.wrap</code>. On peut
ensuite vérifier si le message et rempli et, si nécessaire, on efface la ligne
du haut. Enfin, on ajoute le nouveau message.</p>

<p>Commençons par mettre en place le nouveau journal de messages. Ajoutez un
nouveau journal à <code>engine.py</code> :</p>

<div>
  <button class="btn btn-primary data-toggle-tab active" data-toggle-tab="diff">
    Diff
  </button>
  <button class="btn btn-secondary data-toggle-tab" data-toggle-tab="original">
    Original
  </button>

   <div class="data-pane active" data-pane="diff">
   <div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-diff" data-lang="diff">    fov_map = initialize_fov(game_map)

<span style="color:#a6e22e">+   message_log = MessageLog(message_x, message_width, message_height)
</span><span style="color:#a6e22e"></span>
    key = libtcod.Key()
</code></pre></div>

</div>
<div class="data-pane" data-pane="original">
  
<pre>    fov_map = initialize_fov(game_map)

    <span class="new-text">message_log = MessageLog(message_x, message_width, message_height)</span>

    key = libtcod.Key()</pre>

</div>

</div>


<p>Souvenez-vous d&rsquo;importer aussi le <code>MessaegLog</code> en haut :</p>

<div>
  <button class="btn btn-primary data-toggle-tab active" data-toggle-tab="diff">
    Diff
  </button>
  <button class="btn btn-secondary data-toggle-tab" data-toggle-tab="original">
    Original
  </button>

   <div class="data-pane active" data-pane="diff">
   <div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-diff" data-lang="diff">from fov_functions import initialize_fov, recompute_fov
<span style="color:#a6e22e">+from game_messages import MessageLog
</span><span style="color:#a6e22e"></span>from game_states import GameStates
</code></pre></div>

</div>
<div class="data-pane" data-pane="original">
  
<pre>from fov_functions import initialize_fov, recompute_fov
<span class="new-text">from game_messages import MessageLog</span>
from game_states import GameStates</pre>

</div>

</div>


<p>Notre journal de message étant implémenté, parcourons le projet pour retirer
les expressions <code>print</code> et les remplacer par des messages log.</p>

<p>Commençons par les fonctions &lsquo;death&rsquo;. Dans <code>death_functions.py</code> :</p>

<div>
  <button class="btn btn-primary data-toggle-tab active" data-toggle-tab="diff">
    Diff
  </button>
  <button class="btn btn-secondary data-toggle-tab" data-toggle-tab="original">
    Original
  </button>

   <div class="data-pane active" data-pane="diff">
   <div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-diff" data-lang="diff">import tcod as libtcod

<span style="color:#a6e22e">+from game_messages import Message
</span><span style="color:#a6e22e"></span>
from game_states import GameStates

from render_functions import RenderOrder


def kill_player(player):
    player.char = &#39;%&#39;
    player.color = libtcod.dark_red

<span style="color:#f92672">-   return &#39;You died!&#39;, GameStates.PLAYER_DEAD
</span><span style="color:#f92672"></span><span style="color:#a6e22e">+   return Message(&#39;You died!&#39;, libtcod.red), GameStates.PLAYER_DEAD
</span><span style="color:#a6e22e"></span>

def kill_monster(monster):
<span style="color:#f92672">-   death_message = &#39;{0} is dead!&#39;.format(monster.name.capitalize())
</span><span style="color:#f92672"></span><span style="color:#a6e22e">+   death_message = Message(&#39;{0} is dead!&#39;.format(monster.name.capitalize()), libtcod.orange)
</span><span style="color:#a6e22e"></span>    ...
</code></pre></div>

</div>
<div class="data-pane" data-pane="original">
  
<pre>import tcod as libtcod

<span class="new-text">from game_messages import Message</span>

from game_states import GameStates

from render_functions import RenderOrder


def kill_player(player):
    player.char = '%'
    player.color = libtcod.dark_red

    <span class="crossed-out-text">return 'You died!', GameStates.PLAYER_DEAD</span>
    <span class="new-text">return Message('You died!', libtcod.red), GameStates.PLAYER_DEAD</span>


def kill_monster(monster):
    <span class="crossed-out-text">death_message = '{0} is dead!'.format(monster.name.capitalize())</span>
    <span class="new-text">death_message = Message('{0} is dead!'.format(monster.name.capitalize()), libtcod.orange)</span>
    ...</pre>

</div>

</div>


<p>Ensuite, revenez dans <code>engine.py</code> et remplacez les expressions <code>print</code> comme
ceci :</p>

<div>
  <button class="btn btn-primary data-toggle-tab active" data-toggle-tab="diff">
    Diff
  </button>
  <button class="btn btn-secondary data-toggle-tab" data-toggle-tab="original">
    Original
  </button>

   <div class="data-pane active" data-pane="diff">
   <div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-diff" data-lang="diff">             ...
            (In the player&#39;s results loop)
            ...
            if dead_entity:
                if dead_entity == player:
                    message, game_state = kill_player(dead_entity)
                else:
                    message = kill_monster(dead_entity)

<span style="color:#f92672">-               print(message)
</span><span style="color:#f92672"></span><span style="color:#a6e22e">+               message_log.add_message(message)
</span><span style="color:#a6e22e"></span>            ...
            (In the enemy results loop)
            ...
                        if dead_entity:
                            if dead_entity == player:
                                message, game_state = kill_player(dead_entity)
                            else:
                                message = kill_monster(dead_entity)

<span style="color:#f92672">-                           print(message)
</span><span style="color:#f92672"></span><span style="color:#a6e22e">+                           message_log.add_message(message)
</span><span style="color:#a6e22e"></span>                            ...
</code></pre></div>

</div>
<div class="data-pane" data-pane="original">
  
<pre>             ...
            (In the player's results loop)
            ...
            if dead_entity:
                if dead_entity == player:
                    message, game_state = kill_player(dead_entity)
                else:
                    message = kill_monster(dead_entity)

                <span class="crossed-out-text">print(message)</span>
                <span class="new-text">message_log.add_message(message)</span>
            ...
            (In the enemy results loop)
            ...
                        if dead_entity:
                            if dead_entity == player:
                                message, game_state = kill_player(dead_entity)
                            else:
                                message = kill_monster(dead_entity)

                            <span class="crossed-out-text">print(message)</span>
                            <span class="new-text">message_log.add_message(message)</span>
                            ...</pre>

</div>

</div>


<p>Maintenant pour nos messages d&rsquo;action, dans <code>fighter.py</code> :</p>

<div>
  <button class="btn btn-primary data-toggle-tab active" data-toggle-tab="diff">
    Diff
  </button>
  <button class="btn btn-secondary data-toggle-tab" data-toggle-tab="original">
    Original
  </button>

   <div class="data-pane active" data-pane="diff">
   <div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-diff" data-lang="diff">        ...
        if damage &gt; 0:
<span style="color:#f92672">-           results.append({&#39;message&#39;: &#39;{0} attacks {1} for {2} hit points.&#39;.format(self.owner.name.capitalize(),
</span><span style="color:#f92672">-                                                                                   target.name, str(damage))})
</span><span style="color:#f92672"></span><span style="color:#a6e22e">+           results.append({&#39;message&#39;: Message(&#39;{0} attacks {1} for {2} hit points.&#39;.format(
</span><span style="color:#a6e22e">+               self.owner.name.capitalize(), target.name, str(damage)), libtcod.white)})
</span><span style="color:#a6e22e"></span>            results.extend(target.fighter.take_damage(damage))
        else:
<span style="color:#f92672">-           results.append({&#39;message&#39;: &#39;{0} attacks {1} but does no damage.&#39;.format(self.owner.name.capitalize(),
</span><span style="color:#f92672">-                                                                                   target.name)})
</span><span style="color:#f92672"></span><span style="color:#a6e22e">+           results.append({&#39;message&#39;: Message(&#39;{0} attacks {1} but does no damage.&#39;.format(
</span><span style="color:#a6e22e">+               self.owner.name.capitalize(), target.name), libtcod.white)})
</span><span style="color:#a6e22e"></span>
        return results
</code></pre></div>

</div>
<div class="data-pane" data-pane="original">
  
<pre>        ...
        if damage > 0:
            <span class="crossed-out-text">results.append({'message': '{0} attacks {1} for {2} hit points.'.format(self.owner.name.capitalize(),</span>
                                                                                    <span class="crossed-out-text">target.name, str(damage))})</span>
            <span class="new-text">results.append({'message': Message('{0} attacks {1} for {2} hit points.'.format(
                self.owner.name.capitalize(), target.name, str(damage)), libtcod.white)})</span>
            results.extend(target.fighter.take_damage(damage))
        else:
            <span class="crossed-out-text">results.append({'message': '{0} attacks {1} but does no damage.'.format(self.owner.name.capitalize(),</span>
                                                                                    <span class="crossed-out-text">target.name)})</span>
            <span class="new-text">results.append({'message': Message('{0} attacks {1} but does no damage.'.format(
                self.owner.name.capitalize(), target.name), libtcod.white)})</span>

        return results</pre>

</div>

</div>


<p>Vous devez importer à la fois libtcod et Message pour que cela fonctionne :</p>

<div>
  <button class="btn btn-primary data-toggle-tab active" data-toggle-tab="diff">
    Diff
  </button>
  <button class="btn btn-secondary data-toggle-tab" data-toggle-tab="original">
    Original
  </button>

   <div class="data-pane active" data-pane="diff">
   <div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-diff" data-lang="diff"><span style="color:#a6e22e">+import tcod as libtcod
</span><span style="color:#a6e22e"></span>
<span style="color:#a6e22e">+from game_messages import Message
</span><span style="color:#a6e22e"></span>

class Fighter:
    ...
</code></pre></div>

</div>
<div class="data-pane" data-pane="original">
  
<pre><span class="new-text">import tcod as libtcod

from game_messages import Message</span>


class Fighter:
    ...</pre>

</div>

</div>


<p>Et dans <code>engine.py</code> :</p>

<div>
  <button class="btn btn-primary data-toggle-tab active" data-toggle-tab="diff">
    Diff
  </button>
  <button class="btn btn-secondary data-toggle-tab" data-toggle-tab="original">
    Original
  </button>

   <div class="data-pane active" data-pane="diff">
   <div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-diff" data-lang="diff">            ...
            (In the player&#39;s results loop)
            ...
            if message:
<span style="color:#f92672">-               print(message)
</span><span style="color:#f92672"></span><span style="color:#a6e22e">+               message_log.add_message(message)
</span><span style="color:#a6e22e"></span>            ...
            (In the enemy results loop)
            ...
                        if message:
<span style="color:#f92672">-                           print(message)
</span><span style="color:#f92672"></span><span style="color:#a6e22e">+                           message_log.add_message(message)
</span></code></pre></div>

</div>
<div class="data-pane" data-pane="original">
  
<pre>            ...
            (In the player's results loop)
            ...
            if message:
                <span class="crossed-out-text">print(message)</span>
                <span class="new-text">message_log.add_message(message)</span>
            ...
            (In the enemy results loop)
            ...
                        if message:
                            <span class="crossed-out-text">print(message)</span>
                            <span class="new-text">message_log.add_message(message)</span></pre>

</div>

</div>


<p>Super, maintenant nous ajoutons tous les messages dans le log. Cela étant dit,
rien n&rsquo;apparaît encore. Modifions <code>render_all</code> pour afficher le journal de
message que nous avons crée.</p>

<div>
  <button class="btn btn-primary data-toggle-tab active" data-toggle-tab="diff">
    Diff
  </button>
  <button class="btn btn-secondary data-toggle-tab" data-toggle-tab="original">
    Original
  </button>

   <div class="data-pane active" data-pane="diff">
   <div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-diff" data-lang="diff"><span style="color:#f92672">-def render_all(con, panel, entities, player, game_map, fov_map, fov_recompute, screen_width, screen_height, bar_width,
</span><span style="color:#f92672">-              panel_height, panel_y, colors):
</span><span style="color:#f92672"></span><span style="color:#a6e22e">+def render_all(con, panel, entities, player, game_map, fov_map, fov_recompute, message_log, screen_width, screen_height,
</span><span style="color:#a6e22e">+              bar_width, panel_height, panel_y, colors):
</span><span style="color:#a6e22e"></span>    ...
    libtcod.console_clear(panel)

<span style="color:#a6e22e">+   # Print the game messages, one line at a time
</span><span style="color:#a6e22e">+   y = 1
</span><span style="color:#a6e22e">+   for message in message_log.messages:
</span><span style="color:#a6e22e">+       libtcod.console_set_default_foreground(panel, message.color)
</span><span style="color:#a6e22e">+       libtcod.console_print_ex(panel, message_log.x, y, libtcod.BKGND_NONE, libtcod.LEFT, message.text)
</span><span style="color:#a6e22e">+       y += 1
</span><span style="color:#a6e22e"></span>    ...
</code></pre></div>

</div>
<div class="data-pane" data-pane="original">
  
<pre><span class="crossed-out-text">def render_all(con, panel, entities, player, game_map, fov_map, fov_recompute, screen_width, screen_height, bar_width,</span>
               <span class="crossed-out-text">panel_height, panel_y, colors):</span>
<span class="new-text">def render_all(con, panel, entities, player, game_map, fov_map, fov_recompute, message_log, screen_width, screen_height,
               bar_width, panel_height, panel_y, colors):</span>
    ...
    libtcod.console_clear(panel)

    <span class="new-text"># Print the game messages, one line at a time
    y = 1
    for message in message_log.messages:
        libtcod.console_set_default_foreground(panel, message.color)
        libtcod.console_print_ex(panel, message_log.x, y, libtcod.BKGND_NONE, libtcod.LEFT, message.text)
        y += 1</span>
    ...</pre>

</div>

</div>


<p>Modifiez l&rsquo;appel à <code>render_all</code> depuis <code>engine.py</code> pour inclure le journal
de message :</p>

<div>
  <button class="btn btn-primary data-toggle-tab active" data-toggle-tab="diff">
    Diff
  </button>
  <button class="btn btn-secondary data-toggle-tab" data-toggle-tab="original">
    Original
  </button>

   <div class="data-pane active" data-pane="diff">
   <div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-diff" data-lang="diff"><span style="color:#f92672">-       render_all(con, panel, entities, player, game_map, fov_map, fov_recompute, screen_width, screen_height,
</span><span style="color:#f92672">-                  bar_width, panel_height, panel_y, colors)
</span><span style="color:#f92672"></span><span style="color:#a6e22e">+       render_all(con, panel, entities, player, game_map, fov_map, fov_recompute, message_log, screen_width,
</span><span style="color:#a6e22e">+                  screen_height, bar_width, panel_height, panel_y, colors)
</span></code></pre></div>

</div>
<div class="data-pane" data-pane="original">
  
<pre>        <span class="crossed-out-text">render_all(con, panel, entities, player, game_map, fov_map, fov_recompute, screen_width, screen_height,</span>
                   <span class="crossed-out-text">bar_width, panel_height, panel_y, colors)</span>
        <span class="new-text">render_all(con, panel, entities, player, game_map, fov_map, fov_recompute, message_log, screen_width,
                   screen_height, bar_width, panel_height, panel_y, colors)</span></pre>

</div>

</div>


<p>Lancez le projet maintenant. Tous les anciens &ldquo;print&rdquo; devraient apparaître
dans un journal de message déroulant. Dorenavent nous n&rsquo;utiliserons plus de
print, nous ajouterons tout à notre journal de messages.</p>

<p>Et la suite ? Pourquoi pas un peu d&rsquo;action à la souris ? Notre jeu ne contient
que des orcs et des trolls pour l&rsquo;instant mais peut-être qu&rsquo;un jour nous aurons
des douzaines (centaines ?) de monstres différents et de types d&rsquo;objets. Ce
serait bien qu&rsquo;on puisse voir ce qu&rsquo;ils sont en déplaçant la souris sur eux.</p>

<p>Heureusement pour nous, on a déjà capturé les événements souris dans la variable
<code>mouse</code> juste au dessus de la boucle principale. Tout ce qu&rsquo;il faut faire est
d&rsquo;ajuster notre appel à <code>libtcod.sys_check_for_event</code> pour répondre à la souris
et d&rsquo;écrire le code qui affiche le nom quand on déplace la souris au dessus de
quelquechose.</p>

<div>
  <button class="btn btn-primary data-toggle-tab active" data-toggle-tab="diff">
    Diff
  </button>
  <button class="btn btn-secondary data-toggle-tab" data-toggle-tab="original">
    Original
  </button>

   <div class="data-pane active" data-pane="diff">
   <div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-diff" data-lang="diff"><span style="color:#f92672">-       libtcod.sys_check_for_event(libtcod.EVENT_KEY_PRESS, key, mouse)
</span><span style="color:#f92672"></span><span style="color:#a6e22e">+       libtcod.sys_check_for_event(libtcod.EVENT_KEY_PRESS | libtcod.EVENT_MOUSE, key, mouse)
</span></code></pre></div>

</div>
<div class="data-pane" data-pane="original">
  
<pre>        <span class="crossed-out-text">libtcod.sys_check_for_event(libtcod.EVENT_KEY_PRESS, key, mouse)</span>
        <span class="new-text">libtcod.sys_check_for_event(libtcod.EVENT_KEY_PRESS | libtcod.EVENT_MOUSE, key, mouse)</span></pre>

</div>

</div>


<p>Ajoutez la fonction suivante dans <code>render_functions.py</code> au dessus de
<code>render_bar</code> :</p>

<div>
  <button class="btn btn-primary data-toggle-tab active" data-toggle-tab="diff">
    Diff
  </button>
  <button class="btn btn-secondary data-toggle-tab" data-toggle-tab="original">
    Original
  </button>

   <div class="data-pane active" data-pane="diff">
   <div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-diff" data-lang="diff"><span style="color:#a6e22e">+def get_names_under_mouse(mouse, entities, fov_map):
</span><span style="color:#a6e22e">+   (x, y) = (mouse.cx, mouse.cy)
</span><span style="color:#a6e22e"></span>
<span style="color:#a6e22e">+   names = [entity.name for entity in entities
</span><span style="color:#a6e22e">+            if entity.x == x and entity.y == y and libtcod.map_is_in_fov(fov_map, entity.x, entity.y)]
</span><span style="color:#a6e22e">+   names = &#39;, &#39;.join(names)
</span><span style="color:#a6e22e"></span>
<span style="color:#a6e22e">+   return names.capitalize()
</span><span style="color:#a6e22e"></span>

def render_bar(panel, x, y, total_width, name, value, maximum, bar_color, back_color):
    ...
</code></pre></div>

</div>
<div class="data-pane" data-pane="original">
  
<pre><span class="new-text">def get_names_under_mouse(mouse, entities, fov_map):
    (x, y) = (mouse.cx, mouse.cy)

    names = [entity.name for entity in entities
             if entity.x == x and entity.y == y and libtcod.map_is_in_fov(fov_map, entity.x, entity.y)]
    names = ', '.join(names)

    return names.capitalize()</span>


def render_bar(panel, x, y, total_width, name, value, maximum, bar_color, back_color):
    ...</pre>

</div>

</div>


<p>Maintenant nous allons à nouveau modifier notre fonction <code>render_all</code> (elle a
beaucoup changé dans ce chapitre, n&rsquo;est-ce-pas ?) pour utiliser la souris et
utiliser notre nouvelle fonction.</p>

<div>
  <button class="btn btn-primary data-toggle-tab active" data-toggle-tab="diff">
    Diff
  </button>
  <button class="btn btn-secondary data-toggle-tab" data-toggle-tab="original">
    Original
  </button>

   <div class="data-pane active" data-pane="diff">
   <div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-diff" data-lang="diff"><span style="color:#f92672">-def render_all(con, panel, entities, player, game_map, fov_map, fov_recompute, message_log, screen_width, screen_height,
</span><span style="color:#f92672">-              bar_width, panel_height, panel_y, colors):
</span><span style="color:#f92672"></span><span style="color:#a6e22e">+def render_all(con, panel, entities, player, game_map, fov_map, fov_recompute, message_log, screen_width, screen_height,
</span><span style="color:#a6e22e">+              bar_width, panel_height, panel_y, mouse, colors):
</span><span style="color:#a6e22e"></span>    ...
    render_bar(panel, 1, 1, bar_width, &#39;HP&#39;, player.fighter.hp, player.fighter.max_hp,
               libtcod.light_red, libtcod.darker_red)

<span style="color:#a6e22e">+   libtcod.console_set_default_foreground(panel, libtcod.light_gray)
</span><span style="color:#a6e22e">+   libtcod.console_print_ex(panel, 1, 0, libtcod.BKGND_NONE, libtcod.LEFT,
</span><span style="color:#a6e22e">+                            get_names_under_mouse(mouse, entities, fov_map))
</span><span style="color:#a6e22e"></span>
    libtcod.console_blit(panel, 0, 0, screen_width, panel_height, 0, 0, panel_y)
</code></pre></div>

</div>
<div class="data-pane" data-pane="original">
  
<pre><span class="crossed-out-text">def render_all(con, panel, entities, player, game_map, fov_map, fov_recompute, message_log, screen_width, screen_height,</span>
               <span class="crossed-out-text">bar_width, panel_height, panel_y, colors):</span>
<span class="new-text">def render_all(con, panel, entities, player, game_map, fov_map, fov_recompute, message_log, screen_width, screen_height,
               bar_width, panel_height, panel_y, mouse, colors):</span>
    ...
    render_bar(panel, 1, 1, bar_width, 'HP', player.fighter.hp, player.fighter.max_hp,
               libtcod.light_red, libtcod.darker_red)

    <span class="new-text">libtcod.console_set_default_foreground(panel, libtcod.light_gray)
    libtcod.console_print_ex(panel, 1, 0, libtcod.BKGND_NONE, libtcod.LEFT,
                             get_names_under_mouse(mouse, entities, fov_map))</span>

    libtcod.console_blit(panel, 0, 0, screen_width, panel_height, 0, 0, panel_y)</pre>

</div>

</div>


<p>Et, bien-sûr, nous devons modifier l&rsquo;appel à <code>render_all</code> dans <code>engine.py</code> pour
correspondre à notre nouvelle définition.</p>

<div>
  <button class="btn btn-primary data-toggle-tab active" data-toggle-tab="diff">
    Diff
  </button>
  <button class="btn btn-secondary data-toggle-tab" data-toggle-tab="original">
    Original
  </button>

   <div class="data-pane active" data-pane="diff">
   <div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-diff" data-lang="diff"><span style="color:#f92672">-       render_all(con, panel, entities, player, game_map, fov_map, fov_recompute, message_log, screen_width,
</span><span style="color:#f92672">-                  screen_height, bar_width, panel_height, panel_y, colors)
</span><span style="color:#f92672"></span><span style="color:#a6e22e">+       render_all(con, panel, entities, player, game_map, fov_map, fov_recompute, message_log, screen_width,
</span><span style="color:#a6e22e">+                  screen_height, bar_width, panel_height, panel_y, mouse, colors)
</span></code></pre></div>

</div>
<div class="data-pane" data-pane="original">
  
<pre>        <span class="crossed-out-text">render_all(con, panel, entities, player, game_map, fov_map, fov_recompute, message_log, screen_width,</span>
                   <span class="crossed-out-text">screen_height, bar_width, panel_height, panel_y, colors)</span>
        <span class="new-text">render_all(con, panel, entities, player, game_map, fov_map, fov_recompute, message_log, screen_width,
                   screen_height, bar_width, panel_height, panel_y, mouse, colors)</span></pre>

</div>

</div>


<p>Les graphismes de notre jeu sont bien meilleurs. Si vous espérez que votre jeu
soit joué par d&rsquo;autres joueurs que vous (sinon c&rsquo;est bien aussi !) ce type de
changement sera d&rsquo;une grande importance dans votre projet.</p>

<p>Si vous voulez voir le code actuel entièrement, <a href="https://github.com/TStand90/roguelike_tutorial_revised/tree/part7">cliquez ici</a>.</p>

<p><a href="/tutorials/tcod/part-8">Cliquez ici pour vous rendre à la partie suivante de ce tutoriel.</a></p>

<script src="/js/codetabs.js"></script>


    

    


</article>



        </div>

        <aside class="col-12 col-lg-3 ml-auto blog-sidebar">
    
    
        <section>
    
        
    
        
    
</section>
    
</aside>

      </div>
    </div>
    

    
      







<footer class="blog-footer w-100">
    <nav class="navbar navbar-light bg-light">
        <p class="w-100 text-center">Dernière mise à jour le 24 juillet 2019</p>
        <p class="w-100 text-center"><a href="#">Back to top</a></p>
    </nav>
</footer>

    

    
    
    <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js" integrity="sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49" crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js" integrity="sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy" crossorigin="anonymous"></script>
  </body>
</html>
