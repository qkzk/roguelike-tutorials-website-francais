<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
<meta http-equiv="x-ua-compatible" content="ie=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

<meta property="og:title" content="Part 8 - Les items et l&#39;inventaire" />
<meta property="og:description" content="Pour l&rsquo;instant, notre jeu implémente les mouvements, l&rsquo;exploration des donjons, le combat et l&rsquo;AI (okay, on abuse un peu du terme &ldquo;intelligence&rdquo; dans intelligence artificielle mais vous voyez ce que je veux dire). Il est temps de passer à une étape fondamentale des roguelike : les items ! Pourquoi explorer les donjons si ce n&rsquo;est pour récupérer quelques butins, après tout ?
Commençons par un type d&rsquo;item, les potions de soin en l&rsquo;occurrence et nous passerons à l&rsquo;implémentation de l&rsquo;inventaire." />
<meta property="og:type" content="article" />
<meta property="og:url" content="/tutoriels/tcod/part-8/" />
<meta property="article:published_time" content="2019-03-30T09:33:55-07:00"/>
<meta property="article:modified_time" content="2019-03-30T09:33:55-07:00"/>

<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Part 8 - Les items et l&#39;inventaire"/>
<meta name="twitter:description" content="Pour l&rsquo;instant, notre jeu implémente les mouvements, l&rsquo;exploration des donjons, le combat et l&rsquo;AI (okay, on abuse un peu du terme &ldquo;intelligence&rdquo; dans intelligence artificielle mais vous voyez ce que je veux dire). Il est temps de passer à une étape fondamentale des roguelike : les items ! Pourquoi explorer les donjons si ce n&rsquo;est pour récupérer quelques butins, après tout ?
Commençons par un type d&rsquo;item, les potions de soin en l&rsquo;occurrence et nous passerons à l&rsquo;implémentation de l&rsquo;inventaire."/>



    <link rel="canonical" href="/tutoriels/tcod/part-8/">

    <title>
      
        Part 8 - Les items et l&#39;inventaire | Tutoriel Roguelike
      
    </title>

    
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css" integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO" crossorigin="anonymous">
    <link href="/css/style.css" rel="stylesheet">

    

    

    
  </head>
  <body>
    
      

<header class="blog-header">
    <nav class="navbar navbar-expand-md navbar-dark bg-dark">
        <a class="navbar-brand" href="/">
            Tutoriel Roguelike
        </a>
        <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false"
            aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse justify-content-between" id="navbarNav">
            <ul class="navbar-nav">
                
                
                <li class="nav-item ">
                    
                        <a class="nav-link" href="/">Home</a>
                    
                </li>
                
                <li class="nav-item ">
                    
                        <a class="nav-link" href="/tutoriels/tcod/">Tutoriel TCOD</a>
                    
                </li>
                
                <li class="nav-item ">
                    
                        <a class="nav-link" href="/about/">A propos</a>
                    
                </li>
                
            </ul>
            
        </div>
    </nav>
</header>

    

    
    <div class="container">
      <div class="row">
        <div class="col-12 col-lg-8 blog-main">

          

<header>
    <h2 class="blog-post-title">
    <a class="text-dark" href="/tutoriels/tcod/part-8/">Part 8 - Les items et l&rsquo;inventaire</a>
</h2>

    


<div class="blog-post-date text-secondary">
    
        <time datetime="2019-03-30">Mar 30, 2019</time>
    
    
</div>

    
    
    <hr>
</header>
<article class="blog-post">
    <p>Pour l&rsquo;instant, notre jeu implémente les mouvements, l&rsquo;exploration des donjons,
le combat et l&rsquo;AI (okay, on abuse un peu du terme &ldquo;intelligence&rdquo; dans
intelligence artificielle mais vous voyez ce que je veux dire). Il est temps
de passer à une étape fondamentale des roguelike : les items ! Pourquoi
explorer les donjons si ce n&rsquo;est pour récupérer quelques butins, après tout ?</p>

<p>Commençons par un type d&rsquo;item, les potions de soin en l&rsquo;occurrence et nous
passerons à l&rsquo;implémentation de l&rsquo;inventaire. Dans le chapitre suivant nous
ajouterons d&rsquo;autres types d&rsquo;items mais pour l&rsquo;instant, les potions de soin
feront l&rsquo;affaire.</p>

<p>Faites les changements suivants à <code>place_entities</code> pour placer quelques entités
potions de soin. Elles ne font rien pour l&rsquo;instant mais elles apparaîtront déjà
sur la carte.</p>

<div>
  <button class="btn btn-primary data-toggle-tab active" data-toggle-tab="diff">
    Diff
  </button>
  <button class="btn btn-secondary data-toggle-tab" data-toggle-tab="original">
    Original
  </button>

   <div class="data-pane active" data-pane="diff">
   <div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-diff" data-lang="diff"><span style="color:#f92672">-   def place_entities(self, room, entities, max_monsters_per_room):
</span><span style="color:#f92672"></span><span style="color:#a6e22e">+   def place_entities(self, room, entities, max_monsters_per_room, max_items_per_room):
</span><span style="color:#a6e22e"></span>        number_of_monsters = randint(0, max_monsters_per_room)
<span style="color:#a6e22e">+       number_of_items = randint(0, max_items_per_room)
</span><span style="color:#a6e22e"></span>
        for i in range(number_of_monsters):
            ...

<span style="color:#a6e22e">+       for i in range(number_of_items):
</span><span style="color:#a6e22e">+           x = randint(room.x1 + 1, room.x2 - 1)
</span><span style="color:#a6e22e">+           y = randint(room.y1 + 1, room.y2 - 1)
</span><span style="color:#a6e22e">+
</span><span style="color:#a6e22e">+           if not any([entity for entity in entities if entity.x == x and entity.y == y]):
</span><span style="color:#a6e22e">+               item = Entity(x, y, &#39;!&#39;, libtcod.violet, &#39;Healing Potion&#39;, render_order=RenderOrder.ITEM)
</span><span style="color:#a6e22e">+
</span><span style="color:#a6e22e">+               entities.append(item)
</span></code></pre></div>

</div>
<div class="data-pane" data-pane="original">
  
<pre>    def place_entities(self, room, entities, max_monsters_per_room<span class="new-text">, max_items_per_room</span>):
        number_of_monsters = randint(0, max_monsters_per_room)
        <span class="new-text">number_of_items = randint(0, max_items_per_room)</span>

        for i in range(number_of_monsters):
            ...

        <span class="new-text">for i in range(number_of_items):
            x = randint(room.x1 + 1, room.x2 - 1)
            y = randint(room.y1 + 1, room.y2 - 1)

            if not any([entity for entity in entities if entity.x == x and entity.y == y]):
                item = Entity(x, y, '!', libtcod.violet, 'Healing Potion', render_order=RenderOrder.ITEM)

                entities.append(item)</span></pre>

</div>

</div>


<p>Mettez à jour l&rsquo;appel à <code>place_entities</code> dans <code>make_map</code>.</p>

<div>
  <button class="btn btn-primary data-toggle-tab active" data-toggle-tab="diff">
    Diff
  </button>
  <button class="btn btn-secondary data-toggle-tab" data-toggle-tab="original">
    Original
  </button>

   <div class="data-pane active" data-pane="diff">
   <div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-diff" data-lang="diff"><span style="color:#f92672">-               self.place_entities(new_room, entities, max_monsters_per_room)
</span><span style="color:#f92672"></span><span style="color:#a6e22e">+               self.place_entities(new_room, entities, max_monsters_per_room, max_items_per_room)
</span></code></pre></div>

</div>
<div class="data-pane" data-pane="original">
  
<pre>                self.place_entities(new_room, entities, max_monsters_per_room<span class="new-text">, max_items_per_room</span>)</pre>

</div>

</div>


<p>Mettez la définition de <code>make_map</code> à jour pour inclure la nouvelle variable
<code>max_items_per_room</code>.</p>

<div>
  <button class="btn btn-primary data-toggle-tab active" data-toggle-tab="diff">
    Diff
  </button>
  <button class="btn btn-secondary data-toggle-tab" data-toggle-tab="original">
    Original
  </button>

   <div class="data-pane active" data-pane="diff">
   <div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-diff" data-lang="diff">    def make_map(self, max_rooms, room_min_size, room_max_size, map_width, map_height, player, entities,
<span style="color:#f92672">-                max_monsters_per_room):
</span><span style="color:#f92672"></span><span style="color:#a6e22e">+                max_monsters_per_room, max_items_per_room):
</span></code></pre></div>

</div>
<div class="data-pane" data-pane="original">
  
<pre>    def make_map(self, max_rooms, room_min_size, room_max_size, map_width, map_height, player, entities,
                 max_monsters_per_room<span class="new-text">, max_items_per_room</span>):</pre>

</div>

</div>


<p>Et enfin, l&rsquo;appel dans <code>engine.py</code>. Nous définirons aussi la variable ici.</p>

<div>
  <button class="btn btn-primary data-toggle-tab active" data-toggle-tab="diff">
    Diff
  </button>
  <button class="btn btn-secondary data-toggle-tab" data-toggle-tab="original">
    Original
  </button>

   <div class="data-pane active" data-pane="diff">
   <div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-diff" data-lang="diff">    ...
    max_monsters_per_room = 3
<span style="color:#a6e22e">+   max_items_per_room = 2
</span><span style="color:#a6e22e"></span>    ...
    game_map = GameMap(map_width, map_height)
    game_map.make_map(max_rooms, room_min_size, room_max_size, map_width, map_height, player, entities,
<span style="color:#f92672">-                     max_monsters_per_room)
</span><span style="color:#f92672"></span><span style="color:#a6e22e">+                     max_monsters_per_room, max_items_per_room)
</span><span style="color:#a6e22e"></span>
    fov_recompute = True
    ...
</code></pre></div>

</div>
<div class="data-pane" data-pane="original">
  
<pre>    ...
    max_monsters_per_room = 3
    <span class="new-text">max_items_per_room = 2</span>
    ...
    game_map = GameMap(map_width, map_height)
    game_map.make_map(max_rooms, room_min_size, room_max_size, map_width, map_height, player, entities,
                      max_monsters_per_room, <span class="new-text">max_items_per_room</span>)

    fov_recompute = True
    ...</pre>

</div>

</div>


<p>Vous devriez maintenant voir quelques potions de soin deci delà dans le donjon.
Il est pour l&rsquo;instant impossible de les ramasser. De toute évidence, on peut
commencer par donner au joueur un inventaire. Créons un nouveau composant,
appelé Inventory, qui contiendra une liste d&rsquo;objets ainsi qu&rsquo;une capacité
maximale pour l&rsquo;inventaire. Créez un nouveau fichier dans le dosser
<code>components</code>, appelez le <code>inventory.py</code> et ajoutez-y le code suivant :</p>

<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-py3" data-lang="py3"><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Inventory</span>:
    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">__init__</span>(self, capacity):
        self<span style="color:#f92672">.</span>capacity <span style="color:#f92672">=</span> capacity
        self<span style="color:#f92672">.</span>items <span style="color:#f92672">=</span> []</code></pre></div>

<p>La liste <code>items</code> contiendra la liste des entités. &ldquo;Capacity&rdquo; indique combien
d&rsquo;objets nous pouvons ramasser en tout.</p>

<p>Mais quel type d&rsquo;entités pouvons nous ramassez ? Nous n&rsquo;avons pas forcement
envie que le joueur puisse ramasser <em>n&rsquo;importe quelle</em> entité sur lequel il
marche (les cadavres, par exemple&hellip;) aussi comment les distinguer ?</p>

<p>Créons un nouveau composant, appelé <code>Item</code> que nous ajouterons aux entités
quand nous voudrons qu&rsquo;elle puisse être ramassées. Créez un fichier appelé
<code>item.py</code> dans <code>components</code> et ajoutez-y la classe suivante :</p>

<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-py3" data-lang="py3"><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Item</span>:
    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">__init__</span>(self):
        <span style="color:#66d9ef">pass</span></code></pre></div>

<p>Quoi ? Une classe vide ? Ne vous inquiétez pas, nous y ajouterons des choses
plus intéressantes une fois qu&rsquo;on abordera le ramassage des items. Mais pour
l&rsquo;instant, si une entité a ce composant, on peut la ramasser et sinon on ne
le peut. Aussi, tout ce dont on a besoin pour l&rsquo;instant est d&rsquo;une classe vide.</p>

<p>Maintenant, modifions la classe <code>Entity</code> pour accepter les composants <code>Item</code> et
<code>Inventaire</code>.</p>

<div>
  <button class="btn btn-primary data-toggle-tab active" data-toggle-tab="diff">
    Diff
  </button>
  <button class="btn btn-secondary data-toggle-tab" data-toggle-tab="original">
    Original
  </button>

   <div class="data-pane active" data-pane="diff">
   <div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-diff" data-lang="diff">class Entity:
<span style="color:#f92672">-   def __init__(self, x, y, char, color, name, blocks=False, render_order=RenderOrder.CORPSE, fighter=None, ai=None):
</span><span style="color:#f92672"></span><span style="color:#a6e22e">+   def __init__(self, x, y, char, color, name, blocks=False, render_order=RenderOrder.CORPSE, fighter=None, ai=None,
</span><span style="color:#a6e22e">+                item=None, inventory=None):
</span><span style="color:#a6e22e"></span>        self.x = x
        self.y = y
        self.char = char
        self.color = color
        self.name = name
        self.blocks = blocks
        self.render_order = render_order
        self.fighter = fighter
        self.ai = ai
<span style="color:#a6e22e">+       self.item = item
</span><span style="color:#a6e22e">+       self.inventory = inventory
</span><span style="color:#a6e22e"></span>
        if self.fighter:
            self.fighter.owner = self

        if self.ai:
            self.ai.owner = self

<span style="color:#a6e22e">+       if self.item:
</span><span style="color:#a6e22e">+           self.item.owner = self
</span><span style="color:#a6e22e">+
</span><span style="color:#a6e22e">+       if self.inventory:
</span><span style="color:#a6e22e">+           self.inventory.owner = self
</span></code></pre></div>

</div>
<div class="data-pane" data-pane="original">
  
<pre>class Entity:
    def __init__(self, x, y, char, color, name, blocks=False, render_order=RenderOrder.CORPSE, fighter=None, ai=None<span class="new-text">,
                 item=None, inventory=None</span>):
        self.x = x
        self.y = y
        self.char = char
        self.color = color
        self.name = name
        self.blocks = blocks
        self.render_order = render_order
        self.fighter = fighter
        self.ai = ai
        <span class="new-text">self.item = item
        self.inventory = inventory</span>

        if self.fighter:
            self.fighter.owner = self

        if self.ai:
            self.ai.owner = self

        <span class="new-text">if self.item:
            self.item.owner = self

        if self.inventory:
            self.inventory.owner = self</span></pre>

</div>

</div>


<p>Notre classe <code>Entity</code> étant mise à jour, nous devons modifier le joueur et la
potion de soin pour avoir respectivement les composants <code>Inventory</code> et <code>Item</code>.
Ce tutoriel ne donnera pas aux monstres un inventaire, mais vous pourriez
attacher le composant d&rsquo;inventaire aux monstres pour un effet similaire.</p>

<p>Dans <code>engine.py</code> :</p>

<div>
  <button class="btn btn-primary data-toggle-tab active" data-toggle-tab="diff">
    Diff
  </button>
  <button class="btn btn-secondary data-toggle-tab" data-toggle-tab="original">
    Original
  </button>

   <div class="data-pane active" data-pane="diff">
   <div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-diff" data-lang="diff">    ...
    fighter_component = Fighter(hp=30, defense=2, power=5)
<span style="color:#a6e22e">+   inventory_component = Inventory(26)
</span><span style="color:#a6e22e"></span><span style="color:#f92672">-   player = Entity(0, 0, &#39;@&#39;, libtcod.white, &#39;Player&#39;, blocks=True, render_order=RenderOrder.ACTOR, fighter=fighter_component)
</span><span style="color:#f92672"></span><span style="color:#a6e22e">+   player = Entity(0, 0, &#39;@&#39;, libtcod.white, &#39;Player&#39;, blocks=True, render_order=RenderOrder.ACTOR,
</span><span style="color:#a6e22e">+                   fighter=fighter_component, inventory=inventory_component)
</span><span style="color:#a6e22e"></span>    entities = [player]
    ...
</code></pre></div>

</div>
<div class="data-pane" data-pane="original">
  
<pre>    ...
    fighter_component = Fighter(hp=30, defense=2, power=5)
    <span class="new-text">inventory_component = Inventory(26)</span>
    <span class="crossed-out-text">player = Entity(0, 0, '@', libtcod.white, 'Player', blocks=True, render_order=RenderOrder.ACTOR, fighter=fighter_component)</span>
    <span class="new-text">player = Entity(0, 0, '@', libtcod.white, 'Player', blocks=True, render_order=RenderOrder.ACTOR,
                    fighter=fighter_component, inventory=inventory_component)</span>
    entities = [player]
    ...</pre>

</div>

</div>


<p>Bien-sûr assurez vous d&rsquo;importer <code>Inventory</code> :</p>

<div>
  <button class="btn btn-primary data-toggle-tab active" data-toggle-tab="diff">
    Diff
  </button>
  <button class="btn btn-secondary data-toggle-tab" data-toggle-tab="original">
    Original
  </button>

   <div class="data-pane active" data-pane="diff">
   <div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-diff" data-lang="diff">from components.fighter import Fighter
<span style="color:#a6e22e">+from components.inventory import Inventory
</span><span style="color:#a6e22e"></span>from death_functions import kill_monster, kill_player
...
</code></pre></div>

</div>
<div class="data-pane" data-pane="original">
  
<pre>from components.fighter import Fighter
<span class="new-text">from components.inventory import Inventory</span>
from death_functions import kill_monster, kill_player
...</pre>

</div>

</div>


<p>Ensuite, modifiez la partie relative aux potions de soin de la fonction
<code>place_entities</code>.</p>

<div>
  <button class="btn btn-primary data-toggle-tab active" data-toggle-tab="diff">
    Diff
  </button>
  <button class="btn btn-secondary data-toggle-tab" data-toggle-tab="original">
    Original
  </button>

   <div class="data-pane active" data-pane="diff">
   <div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-diff" data-lang="diff"><span style="color:#a6e22e">+               item_component = Item()
</span><span style="color:#a6e22e"></span><span style="color:#f92672">-               item = Entity(x, y, &#39;!&#39;, libtcod.violet, &#39;Healing Potion&#39;, render_order=RenderOrder.ITEM)
</span><span style="color:#f92672"></span><span style="color:#a6e22e">+               item = Entity(x, y, &#39;!&#39;, libtcod.violet, &#39;Healing Potion&#39;, render_order=RenderOrder.ITEM,
</span><span style="color:#a6e22e">+                             item=item_component)
</span></code></pre></div>

</div>
<div class="data-pane" data-pane="original">
  
<pre>                <span class="new-text">item_component = Item()</span>
                <span class="crossed-out-text">item = Entity(x, y, '!', libtcod.violet, 'Healing Potion', render_order=RenderOrder.ITEM)</span>
                <span class="new-text">item = Entity(x, y, '!', libtcod.violet, 'Healing Potion', render_order=RenderOrder.ITEM,
                              item=item_component)</span></pre>

</div>

</div>


<p>&hellip; Et pensez à l&rsquo;import :</p>

<div>
  <button class="btn btn-primary data-toggle-tab active" data-toggle-tab="diff">
    Diff
  </button>
  <button class="btn btn-secondary data-toggle-tab" data-toggle-tab="original">
    Original
  </button>

   <div class="data-pane active" data-pane="diff">
   <div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-diff" data-lang="diff">...
from components.ai import BasicMonster
from components.fighter import Fighter
<span style="color:#a6e22e">+from components.item import Item
</span><span style="color:#a6e22e"></span>
from entity import Entity
...
</code></pre></div>

</div>
<div class="data-pane" data-pane="original">
  
<pre>...
from components.ai import BasicMonster
from components.fighter import Fighter
<span class="new-text">from components.item import Item</span>

from entity import Entity
...</pre>

</div>

</div>


<p>Comment notre joeur va-t-il s&rsquo;y prendre pour ramasser les objets ? Les
roguelikes permettent généralement de ramasser un item sur lequel on se trouve
et le notre ne sera pas différent. Nombreux sont ceux qui utilisent la touche
&lsquo;g&rsquo; (certainement pour &lsquo;grab&rsquo;, ramasser ou &lsquo;get&rsquo;, obtenir) pour ramasser et
nous ferons de même. Modifiez <code>handle_keys</code> dans <code>input_handlers.py</code> pour
utiliser la touche &lsquo;g&rsquo;.</p>

<div>
  <button class="btn btn-primary data-toggle-tab active" data-toggle-tab="diff">
    Diff
  </button>
  <button class="btn btn-secondary data-toggle-tab" data-toggle-tab="original">
    Original
  </button>

   <div class="data-pane active" data-pane="diff">
   <div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-diff" data-lang="diff">    ...
    elif key_char == &#39;n&#39;:
        return {&#39;move&#39;: (1, 1)}

<span style="color:#a6e22e">+   if key_char == &#39;g&#39;:
</span><span style="color:#a6e22e">+       return {&#39;pickup&#39;: True}
</span><span style="color:#a6e22e"></span>
    if key.vk == libtcod.KEY_ENTER and key.lalt:
        ...
</code></pre></div>

</div>
<div class="data-pane" data-pane="original">
  
<pre>    ...
    elif key_char == 'n':
        return {'move': (1, 1)}

    <span class="new-text">if key_char == 'g':
        return {'pickup': True}</span>

    if key.vk == libtcod.KEY_ENTER and key.lalt:
        ...</pre>

</div>

</div>


<p>Maintenant nous devons vérifier l&rsquo;action de ramasser dans notre moteur.</p>

<div>
  <button class="btn btn-primary data-toggle-tab active" data-toggle-tab="diff">
    Diff
  </button>
  <button class="btn btn-secondary data-toggle-tab" data-toggle-tab="original">
    Original
  </button>

   <div class="data-pane active" data-pane="diff">
   <div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-diff" data-lang="diff">        ...
        move = action.get(&#39;move&#39;)
<span style="color:#a6e22e">+       pickup = action.get(&#39;pickup&#39;)
</span><span style="color:#a6e22e"></span>        exit = action.get(&#39;exit&#39;)
        ...
</code></pre></div>

</div>
<div class="data-pane" data-pane="original">
  
<pre>        ...
        move = action.get('move')
        <span class="new-text">pickup = action.get('pickup')</span>
        exit = action.get('exit')
        ...</pre>

</div>

</div>


<p>Maintenant nous devons <em>faire</em> quelque chose quand cette variable &lsquo;pickup&rsquo;
(ramasser) est vraie. D&rsquo;abord, nous allons créer une méthode de la classe
<code>Inventory</code> pour ajouter un item à l&rsquo;inventaire. Nous utiliserons le même
concept de de &ldquo;results&rdquo; que la dernière fois. Si l&rsquo;ajout d&rsquo;un objet à
l&rsquo;inventaire est réussi nous renvoyons un résultat disant qu&rsquo;on a ramassé
l&rsquo;objet. Sinon on envoie un résultat qui indique un échec. Le moteur devra
déterminer ce qu&rsquo;il faut faire avec l&rsquo;entité &ldquo;item&rdquo;.</p>

<div>
  <button class="btn btn-primary data-toggle-tab active" data-toggle-tab="diff">
    Diff
  </button>
  <button class="btn btn-secondary data-toggle-tab" data-toggle-tab="original">
    Original
  </button>

   <div class="data-pane active" data-pane="diff">
   <div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-diff" data-lang="diff"><span style="color:#a6e22e">+import tcod as libtcod
</span><span style="color:#a6e22e"></span>
<span style="color:#a6e22e">+from game_messages import Message
</span><span style="color:#a6e22e"></span>

class Inventory:
    def __init__(self, capacity):
        self.capacity = capacity
        self.items = []

<span style="color:#a6e22e">+   def add_item(self, item):
</span><span style="color:#a6e22e">+       results = []
</span><span style="color:#a6e22e">+
</span><span style="color:#a6e22e">+       if len(self.items) &gt;= self.capacity:
</span><span style="color:#a6e22e">+           results.append({
</span><span style="color:#a6e22e">+               &#39;item_added&#39;: None,
</span><span style="color:#a6e22e">+               &#39;message&#39;: Message(&#39;You cannot carry any more, your inventory is full&#39;, libtcod.yellow)
</span><span style="color:#a6e22e">+           })
</span><span style="color:#a6e22e">+       else:
</span><span style="color:#a6e22e">+           results.append({
</span><span style="color:#a6e22e">+               &#39;item_added&#39;: item,
</span><span style="color:#a6e22e">+               &#39;message&#39;: Message(&#39;You pick up the {0}!&#39;.format(item.name), libtcod.blue)
</span><span style="color:#a6e22e">+           })
</span><span style="color:#a6e22e">+
</span><span style="color:#a6e22e">+           self.items.append(item)
</span><span style="color:#a6e22e">+
</span><span style="color:#a6e22e">+       return results
</span></code></pre></div>

</div>
<div class="data-pane" data-pane="original">
  
<pre><span class="new-text">import tcod as libtcod

from game_messages import Message</span>


class Inventory:
    def __init__(self, capacity):
        self.capacity = capacity
        self.items = []

    <span class="new-text">def add_item(self, item):
        results = []

        if len(self.items) >= self.capacity:
            results.append({
                'item_added': None,
                'message': Message('You cannot carry any more, your inventory is full', libtcod.yellow)
            })
        else:
            results.append({
                'item_added': item,
                'message': Message('You pick up the {0}!'.format(item.name), libtcod.blue)
            })

            self.items.append(item)

        return results</span></pre>

</div>

</div>


<p>Ajoutons du code à <code>engine.py</code> pour exécuter le résultat de l&rsquo;ajout d&rsquo;un objet
à l&rsquo;inventaire.</p>

<div>
  <button class="btn btn-primary data-toggle-tab active" data-toggle-tab="diff">
    Diff
  </button>
  <button class="btn btn-secondary data-toggle-tab" data-toggle-tab="original">
    Original
  </button>

   <div class="data-pane active" data-pane="diff">
   <div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-diff" data-lang="diff">        if move and game_state == GameStates.PLAYERS_TURN:
            ...

<span style="color:#a6e22e">+       elif pickup and game_state == GameStates.PLAYERS_TURN:
</span><span style="color:#a6e22e">+           for entity in entities:
</span><span style="color:#a6e22e">+               if entity.item and entity.x == player.x and entity.y == player.y:
</span><span style="color:#a6e22e">+                   pickup_results = player.inventory.add_item(entity)
</span><span style="color:#a6e22e">+                   player_turn_results.extend(pickup_results)
</span><span style="color:#a6e22e">+
</span><span style="color:#a6e22e">+                   break
</span><span style="color:#a6e22e">+           else:
</span><span style="color:#a6e22e">+               message_log.add_message(Message(&#39;There is nothing here to pick up.&#39;, libtcod.yellow))
</span><span style="color:#a6e22e"></span>
        if exit:
            ...
</code></pre></div>

</div>
<div class="data-pane" data-pane="original">
  
<pre>        if move and game_state == GameStates.PLAYERS_TURN:
            ...

        <span class="new-text">elif pickup and game_state == GameStates.PLAYERS_TURN:
            for entity in entities:
                if entity.item and entity.x == player.x and entity.y == player.y:
                    pickup_results = player.inventory.add_item(entity)
                    player_turn_results.extend(pickup_results)

                    break
            else:
                message_log.add_message(Message('There is nothing here to pick up.', libtcod.yellow))</span>

        if exit:
            ...</pre>

</div>

</div>


<p>Nous devons importer <code>Message</code> pour que cela fonctionne :</p>

<div>
  <button class="btn btn-primary data-toggle-tab active" data-toggle-tab="diff">
    Diff
  </button>
  <button class="btn btn-secondary data-toggle-tab" data-toggle-tab="original">
    Original
  </button>

   <div class="data-pane active" data-pane="diff">
   <div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-diff" data-lang="diff"><span style="color:#f92672">-from game_messages import MessageLog
</span><span style="color:#f92672"></span><span style="color:#a6e22e">+from game_messages import Message, MessageLog
</span></code></pre></div>

</div>
<div class="data-pane" data-pane="original">
  
<pre>from game_messages import <span class="new-text">Message,</span> MessageLog</pre>

</div>

</div>


<p>Pour faire simple, nous bouclons sur chaque entité de la carte, vérifiant si
c&rsquo;est un objet et si elle est disposée à la même place que le joueur. Si c&rsquo;est
le cas on l&rsquo;ajoute à l&rsquo;inventaire et on ajoute le résultat à
<code>player_turn_results</code> et sinon, on crée un message pour informer le joueur que
rien ne peut être ramassé. L&rsquo;expression &lsquo;break&rsquo; nous assure qu&rsquo;on ne peut
ramasser qu&rsquo;un objet à la fois (mais peut-être que dans votre jeu, vous
permettrez au joueur d&rsquo;en ramasser plusieurs d&rsquo;un coup).</p>

<p>Maintenant, passons à l&rsquo;exécution du &ldquo;ramassage&rdquo; dans notre boucle qui s&rsquo;occupe
du résultat du tour du joueur.</p>

<div>
  <button class="btn btn-primary data-toggle-tab active" data-toggle-tab="diff">
    Diff
  </button>
  <button class="btn btn-secondary data-toggle-tab" data-toggle-tab="original">
    Original
  </button>

   <div class="data-pane active" data-pane="diff">
   <div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-diff" data-lang="diff">        ...
        for player_turn_result in player_turn_results:
            message = player_turn_result.get(&#39;message&#39;)
            dead_entity = player_turn_result.get(&#39;dead&#39;)
<span style="color:#a6e22e">+           item_added = player_turn_result.get(&#39;item_added&#39;)
</span><span style="color:#a6e22e"></span>
            if message:
                message_log.add_message(message)

            if dead_entity:
                if dead_entity == player:
                    message, game_state = kill_player(dead_entity)
                else:
                    message = kill_monster(dead_entity)

                message_log.add_message(message)

<span style="color:#a6e22e">+           if item_added:
</span><span style="color:#a6e22e">+               entities.remove(item_added)
</span><span style="color:#a6e22e">+
</span><span style="color:#a6e22e">+               game_state = GameStates.ENEMY_TURN
</span><span style="color:#a6e22e"></span>
        if game_state == GameStates.ENEMY_TURN:
            ...
</code></pre></div>

</div>
<div class="data-pane" data-pane="original">
  
<pre>        ...
        for player_turn_result in player_turn_results:
            message = player_turn_result.get('message')
            dead_entity = player_turn_result.get('dead')
            <span class="new-text">item_added = player_turn_result.get('item_added')</span>

            if message:
                message_log.add_message(message)

            if dead_entity:
                if dead_entity == player:
                    message, game_state = kill_player(dead_entity)
                else:
                    message = kill_monster(dead_entity)

                message_log.add_message(message)

            <span class="new-text">if item_added:
                entities.remove(item_added)

                game_state = GameStates.ENEMY_TURN</span>

        if game_state == GameStates.ENEMY_TURN:
            ...</pre>

</div>

</div>


<p>Cette partie s&rsquo;occupe de retirer l&rsquo;entité de la liste des entités
affichées maintenant que cela est dans l&rsquo;inventaire du joueur et non plus
sur la carte et passe le tour à l&rsquo;ennemi. Plutôt simple.</p>

<p>Lancez le projet et vous devriez être capable de ramasser les potions de soin
du sol. Bien sûr, cela ne fait aucun bien à notre vagabond pour l&rsquo;instant,
on ne peut rien en faire. Ce n&rsquo;est donc qu&rsquo;un gachis de tour.</p>

<p>Avant d&rsquo;en passer à l&rsquo;utilisation de l&rsquo;objet, nous devons avoir un moyen
d&rsquo;examiner et de choisir les objets à utiliser. Nous créons une interface pour
l&rsquo;inventaire que le joueur peut ouvrir et dans lequel il peut choisir un objet.
Créons un nouveau fichier, appelé <code>menus.py</code> où nous stockerons nos fonctions de
menus pour l&rsquo;inventaire et tous les autres menus dont on aura besoin dans ce
tutoriel. Ajoutez-y le code suivant :</p>

<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-py3" data-lang="py3"><span style="color:#f92672">import</span> tcod <span style="color:#66d9ef">as</span> libtcod


<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">menu</span>(con, header, options, width, screen_width, screen_height):
    <span style="color:#66d9ef">if</span> len(options) <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">26</span>: <span style="color:#66d9ef">raise</span> <span style="color:#a6e22e">ValueError</span>(<span style="color:#e6db74">&#39;Cannot have a menu with more than 26 options.&#39;</span>)

    <span style="color:#75715e"># calculate total height for the header (after auto-wrap) and one line per option</span>
    header_height <span style="color:#f92672">=</span> libtcod<span style="color:#f92672">.</span>console_get_height_rect(con, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">0</span>, width, screen_height, header)
    height <span style="color:#f92672">=</span> len(options) <span style="color:#f92672">+</span> header_height

    <span style="color:#75715e"># create an off-screen console that represents the menu&#39;s window</span>
    window <span style="color:#f92672">=</span> libtcod<span style="color:#f92672">.</span>console_new(width, height)

    <span style="color:#75715e"># print the header, with auto-wrap</span>
    libtcod<span style="color:#f92672">.</span>console_set_default_foreground(window, libtcod<span style="color:#f92672">.</span>white)
    libtcod<span style="color:#f92672">.</span>console_print_rect_ex(window, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">0</span>, width, height, libtcod<span style="color:#f92672">.</span>BKGND_NONE, libtcod<span style="color:#f92672">.</span>LEFT, header)

    <span style="color:#75715e"># print all the options</span>
    y <span style="color:#f92672">=</span> header_height
    letter_index <span style="color:#f92672">=</span> ord(<span style="color:#e6db74">&#39;a&#39;</span>)
    <span style="color:#66d9ef">for</span> option_text <span style="color:#f92672">in</span> options:
        text <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;(&#39;</span> <span style="color:#f92672">+</span> chr(letter_index) <span style="color:#f92672">+</span> <span style="color:#e6db74">&#39;) &#39;</span> <span style="color:#f92672">+</span> option_text
        libtcod<span style="color:#f92672">.</span>console_print_ex(window, <span style="color:#ae81ff">0</span>, y, libtcod<span style="color:#f92672">.</span>BKGND_NONE, libtcod<span style="color:#f92672">.</span>LEFT, text)
        y <span style="color:#f92672">+=</span> <span style="color:#ae81ff">1</span>
        letter_index <span style="color:#f92672">+=</span> <span style="color:#ae81ff">1</span>

    <span style="color:#75715e"># blit the contents of &#34;window&#34; to the root console</span>
    x <span style="color:#f92672">=</span> int(screen_width <span style="color:#f92672">/</span> <span style="color:#ae81ff">2</span> <span style="color:#f92672">-</span> width <span style="color:#f92672">/</span> <span style="color:#ae81ff">2</span>)
    y <span style="color:#f92672">=</span> int(screen_height <span style="color:#f92672">/</span> <span style="color:#ae81ff">2</span> <span style="color:#f92672">-</span> height <span style="color:#f92672">/</span> <span style="color:#ae81ff">2</span>)
    libtcod<span style="color:#f92672">.</span>console_blit(window, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">0</span>, width, height, <span style="color:#ae81ff">0</span>, x, y, <span style="color:#ae81ff">1.0</span>, <span style="color:#ae81ff">0.7</span>)</code></pre></div>

<div>
  <button class="btn btn-primary data-toggle-tab active" data-toggle-tab="diff">
    Diff
  </button>
  <button class="btn btn-secondary data-toggle-tab" data-toggle-tab="original">
    Original
  </button>

   <div class="data-pane active" data-pane="diff">
   <div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-diff" data-lang="diff">def menu(con, header, options, width, screen_width, screen_height):
    ...

<span style="color:#a6e22e">+def inventory_menu(con, header, inventory, inventory_width, screen_width, screen_height):
</span><span style="color:#a6e22e">+   # show a menu with each item of the inventory as an option
</span><span style="color:#a6e22e">+   if len(inventory.items) == 0:
</span><span style="color:#a6e22e">+       options = [&#39;Inventory is empty.&#39;]
</span><span style="color:#a6e22e">+   else:
</span><span style="color:#a6e22e">+       options = [item.name for item in inventory.items]
</span><span style="color:#a6e22e">+
</span><span style="color:#a6e22e">+   menu(con, header, options, inventory_width, screen_width, screen_height)
</span></code></pre></div>

</div>
<div class="data-pane" data-pane="original">
  
<pre>def menu(con, header, options, width, screen_width, screen_height):
    ...

<span class="new-text">def inventory_menu(con, header, inventory, inventory_width, screen_width, screen_height):
    # show a menu with each item of the inventory as an option
    if len(inventory.items) == 0:
        options = ['Inventory is empty.']
    else:
        options = [item.name for item in inventory.items]

    menu(con, header, options, inventory_width, screen_width, screen_height)</span></pre>

</div>

</div>


<p>Comment afficher ce menu ? Une manière est de changer l&rsquo;état du jeu et, quand
l&rsquo;état du jeu est sur <code>menu d'inventaire</code>, on affiche le menu et on accepte
les saisies clavier. Aussi ajoutons l&rsquo;option à <code>GameStates</code> :</p>

<div>
  <button class="btn btn-primary data-toggle-tab active" data-toggle-tab="diff">
    Diff
  </button>
  <button class="btn btn-secondary data-toggle-tab" data-toggle-tab="original">
    Original
  </button>

   <div class="data-pane active" data-pane="diff">
   <div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-diff" data-lang="diff">from enum import Enum


class GameStates(Enum):
    PLAYERS_TURN = 1
    ENEMY_TURN = 2
    PLAYER_DEAD = 3
<span style="color:#a6e22e">+   SHOW_INVENTORY = 4
</span></code></pre></div>

</div>
<div class="data-pane" data-pane="original">
  
<pre>from enum import Enum


class GameStates(Enum):
    PLAYERS_TURN = 1
    ENEMY_TURN = 2
    PLAYER_DEAD = 3
    <span class="new-text">SHOW_INVENTORY = 4</span></pre>

</div>

</div>


<p>Quand bascule-t-on vers ce nouvel état ? Ajoutons une nouvelle touche pour
passer en mode &ldquo;inventaire&rdquo;.  Ainsi que vous l&rsquo;aurez deviné on utilisera la
touche &ldquo;i&rdquo; pour ce faire.</p>

<div>
  <button class="btn btn-primary data-toggle-tab active" data-toggle-tab="diff">
    Diff
  </button>
  <button class="btn btn-secondary data-toggle-tab" data-toggle-tab="original">
    Original
  </button>

   <div class="data-pane active" data-pane="diff">
   <div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-diff" data-lang="diff">    ...
    if key_char == &#39;g&#39;:
        return {&#39;pickup&#39;: True}

<span style="color:#a6e22e">+   elif key_char == &#39;i&#39;:
</span><span style="color:#a6e22e">+       return {&#39;show_inventory&#39;: True}
</span><span style="color:#a6e22e"></span>
    if key.vk == libtcod.KEY_ENTER and key.lalt:
        ...
</code></pre></div>

</div>
<div class="data-pane" data-pane="original">
  
<pre>    ...
    if key_char == 'g':
        return {'pickup': True}

    <span class="new-text">elif key_char == 'i':
        return {'show_inventory': True}</span>

    if key.vk == libtcod.KEY_ENTER and key.lalt:
        ...</pre>

</div>

</div>


<p>Non seulement voulons nous basculer l&rsquo;état du jeu vers <code>SHOW_INVENTORY</code>
(afficher l&rsquo;inventaire) mais aussi voulons nous revenir vers le précédent état
du jeu si nous quittons le menu sans rien faire. Cela permet aussi de ne pas
gaspiller un tour si on se contente d&rsquo;ouvrir l&rsquo;inventaire ainsi que d&rsquo;ouvrir
l&rsquo;inventaire après la mort (la rendant encore plus douloureuse). Aussi nous
avons besoin d&rsquo;une variable qui retienne l&rsquo;état précédent.</p>

<div>
  <button class="btn btn-primary data-toggle-tab active" data-toggle-tab="diff">
    Diff
  </button>
  <button class="btn btn-secondary data-toggle-tab" data-toggle-tab="original">
    Original
  </button>

   <div class="data-pane active" data-pane="diff">
   <div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-diff" data-lang="diff">    ...
    game_state = GameStates.PLAYERS_TURN
<span style="color:#a6e22e">+   previous_game_state = game_state
</span><span style="color:#a6e22e"></span>
    while not libtcod.console_is_window_closed():
        ...
</code></pre></div>

</div>
<div class="data-pane" data-pane="original">
  
<pre>    ...
    game_state = GameStates.PLAYERS_TURN
    <span class="new-text">previous_game_state = game_state</span>

    while not libtcod.console_is_window_closed():
        ...</pre>

</div>

</div>


<div>
  <button class="btn btn-primary data-toggle-tab active" data-toggle-tab="diff">
    Diff
  </button>
  <button class="btn btn-secondary data-toggle-tab" data-toggle-tab="original">
    Original
  </button>

   <div class="data-pane active" data-pane="diff">
   <div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-diff" data-lang="diff">        ...
        pickup = action.get(&#39;pickup&#39;)
<span style="color:#a6e22e">+       show_inventory = action.get(&#39;show_inventory&#39;)
</span><span style="color:#a6e22e"></span>        exit = action.get(&#39;exit&#39;)
        ...
</code></pre></div>

</div>
<div class="data-pane" data-pane="original">
  
<pre>        ...
        pickup = action.get('pickup')
        <span class="new-text">show_inventory = action.get('show_inventory')</span>
        exit = action.get('exit')
        ...</pre>

</div>

</div>


<div>
  <button class="btn btn-primary data-toggle-tab active" data-toggle-tab="diff">
    Diff
  </button>
  <button class="btn btn-secondary data-toggle-tab" data-toggle-tab="original">
    Original
  </button>

   <div class="data-pane active" data-pane="diff">
   <div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-diff" data-lang="diff">        elif pickup and game_state == GameStates.PLAYERS_TURN:
            ...

<span style="color:#a6e22e">+       if show_inventory:
</span><span style="color:#a6e22e">+           previous_game_state = game_state
</span><span style="color:#a6e22e">+           game_state = GameStates.SHOW_INVENTORY
</span><span style="color:#a6e22e"></span>
        if exit:
<span style="color:#f92672">-           return True
</span><span style="color:#f92672"></span><span style="color:#a6e22e">+           if game_state == GameStates.SHOW_INVENTORY:
</span><span style="color:#a6e22e">+               game_state = previous_game_state
</span><span style="color:#a6e22e">+           else:
</span><span style="color:#a6e22e">+               return True
</span></code></pre></div>

</div>
<div class="data-pane" data-pane="original">
  
<pre>
        elif pickup and game_state == GameStates.PLAYERS_TURN:
            ...

        <span class="new-text">if show_inventory:
            previous_game_state = game_state
            game_state = GameStates.SHOW_INVENTORY</span>

        if exit:
            <span class="new-text">if game_state == GameStates.SHOW_INVENTORY:
                game_state = previous_game_state
            else:</span>
                <span style="color: blue">return True</span></pre>

</div>

</div>


<p>Nous modifions notre précédente fonction de sortie pour revenir à l&rsquo;état
précédent si on ouvre l&rsquo;inventaire. Ainsi, la touche &ldquo;escape&rdquo; ferme seulement
le menu sans quitter le jeu.</p>

<p>Maintenant nous basculons l&rsquo;état du jeu mais nous devons toujours afficher le
menu. Cela va sans dire, nous devons modifier <code>render_all</code>. L&rsquo;inventaire n&rsquo;étant
affiché que lorsque l&rsquo;état est sur <code>SHOW_INVENTORY</code>, la fonction <code>render_all</code>
doit connaître cet état. Modifiez l&rsquo;appel dans <code>engine.py</code>.</p>

<div>
  <button class="btn btn-primary data-toggle-tab active" data-toggle-tab="diff">
    Diff
  </button>
  <button class="btn btn-secondary data-toggle-tab" data-toggle-tab="original">
    Original
  </button>

   <div class="data-pane active" data-pane="diff">
   <div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-diff" data-lang="diff"><span style="color:#f92672">-render_all(con, panel, entities, player, game_map, fov_map, fov_recompute, message_log, screen_width,
</span><span style="color:#f92672">-                  screen_height, bar_width, panel_height, panel_y, mouse, colors)
</span><span style="color:#f92672"></span><span style="color:#a6e22e">+render_all(con, panel, entities, player, game_map, fov_map, fov_recompute, message_log, screen_width,
</span><span style="color:#a6e22e">+                  screen_height, bar_width, panel_height, panel_y, mouse, colors, game_state)
</span></code></pre></div>

</div>
<div class="data-pane" data-pane="original">
  
<pre>render_all(con, panel, entities, player, game_map, fov_map, fov_recompute, message_log, screen_width,
                   screen_height, bar_width, panel_height, panel_y, mouse, colors, <span class="new-text">game_state</span>)</pre>

</div>

</div>


<p>Et maintenant la définition :</p>

<div>
  <button class="btn btn-primary data-toggle-tab active" data-toggle-tab="diff">
    Diff
  </button>
  <button class="btn btn-secondary data-toggle-tab" data-toggle-tab="original">
    Original
  </button>

   <div class="data-pane active" data-pane="diff">
   <div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-diff" data-lang="diff">def render_all(con, panel, entities, player, game_map, fov_map, fov_recompute, message_log, screen_width, screen_height,
<span style="color:#f92672">-              bar_width, panel_height, panel_y, mouse, colors):
</span><span style="color:#f92672"></span><span style="color:#a6e22e">+              bar_width, panel_height, panel_y, mouse, colors, game_state):
</span><span style="color:#a6e22e"></span>    ...
    ...
    libtcod.console_blit(panel, 0, 0, screen_width, panel_height, 0, 0, panel_y)

<span style="color:#a6e22e">+   if game_state == GameStates.SHOW_INVENTORY:
</span><span style="color:#a6e22e">+       inventory_menu(con, &#39;Press the key next to an item to use it, or Esc to cancel.\n&#39;,
</span><span style="color:#a6e22e">+                      player.inventory, 50, screen_width, screen_height)
</span></code></pre></div>

</div>
<div class="data-pane" data-pane="original">
  
<pre>def render_all(con, panel, entities, player, game_map, fov_map, fov_recompute, message_log, screen_width, screen_height,
               bar_width, panel_height, panel_y, mouse, colors<span class="new-text">, game_state</span>):
    ...
    ...
    libtcod.console_blit(panel, 0, 0, screen_width, panel_height, 0, 0, panel_y)

    <span class="new-text">if game_state == GameStates.SHOW_INVENTORY:
        inventory_menu(con, 'Press the key next to an item to use it, or Esc to cancel.\n',
                       player.inventory, 50, screen_width, screen_height)</span></pre>

</div>

</div>


<p>Nous devons importer <code>GameStates</code> et <code>inventory_menu</code> pour que cela fontionne.</p>

<div>
  <button class="btn btn-primary data-toggle-tab active" data-toggle-tab="diff">
    Diff
  </button>
  <button class="btn btn-secondary data-toggle-tab" data-toggle-tab="original">
    Original
  </button>

   <div class="data-pane active" data-pane="diff">
   <div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-diff" data-lang="diff">import tcod as libtcod

from enum import Enum

<span style="color:#a6e22e">+from game_states import GameStates
</span><span style="color:#a6e22e">+
</span><span style="color:#a6e22e">+from menus import inventory_menu
</span><span style="color:#a6e22e"></span>

class RenderOrder(Enum):
    ...
</code></pre></div>

</div>
<div class="data-pane" data-pane="original">
  
<pre>import tcod as libtcod

from enum import Enum

<span class="new-text">from game_states import GameStates

from menus import inventory_menu</span>


class RenderOrder(Enum):
    ...</pre>

</div>

</div>


<p>Lancez le projet maintenant. Vous devriez pouvoir ouvrir l&rsquo;inventaire et voir
tous les objets ramassés jusque là. Nous ne pouvons toujours rien en faire
mais nous y sommes presque !</p>

<p>De manière à choisir un objet de l&rsquo;inventaire, nous devons modifier
<code>handle_keys</code>. Pourquoi ? Parce que nous allons choisir les objets avec les
touches du clavier ce qui est très bien mais certaines sont déjà utilisées
pour le déplacement et d&rsquo;autres choses. Il serait agréable que notre fonction
réagisse différemment selon l&rsquo;état du jeu.</p>

<p>Voici ce qu&rsquo;on va faire : nous allons séparer <code>handle_keys</code> en différentes
fonctions, chacune renvoyant un résultat différent selon l&rsquo;état du jeu. Renommez
la fonction <code>handle_keys</code> en <code>handle_player_turn_keys</code> :</p>

<div>
  <button class="btn btn-primary data-toggle-tab active" data-toggle-tab="diff">
    Diff
  </button>
  <button class="btn btn-secondary data-toggle-tab" data-toggle-tab="original">
    Original
  </button>

   <div class="data-pane active" data-pane="diff">
   <div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-diff" data-lang="diff"><span style="color:#f92672">-def handle_keys(key):
</span><span style="color:#f92672"></span><span style="color:#a6e22e">+def handle_player_turn_keys(key):
</span></code></pre></div>

</div>
<div class="data-pane" data-pane="original">
  
<pre><span class="crossed-out-text">def handle_keys(key):</span>
<span class="new-text">def handle_player_turn_keys(key):</span></pre>

</div>

</div>


<p>Ensuite, créez une nouvelle fonction <code>handle_keys</code> qui appelle
<code>handle_player_turn_keys</code>.</p>

<div>
  <button class="btn btn-primary data-toggle-tab active" data-toggle-tab="diff">
    Diff
  </button>
  <button class="btn btn-secondary data-toggle-tab" data-toggle-tab="original">
    Original
  </button>

   <div class="data-pane active" data-pane="diff">
   <div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-diff" data-lang="diff">import tcod as libtcod

<span style="color:#a6e22e">+from game_states import GameStates
</span><span style="color:#a6e22e">+
</span><span style="color:#a6e22e">+
</span><span style="color:#a6e22e">+def handle_keys(key, game_state):
</span><span style="color:#a6e22e">+   if game_state == GameStates.PLAYERS_TURN:
</span><span style="color:#a6e22e">+       return handle_player_turn_keys(key)
</span><span style="color:#a6e22e">+
</span><span style="color:#a6e22e">+   return {}
</span><span style="color:#a6e22e"></span>

def handle_player_turn_keys(key):
    ...
</code></pre></div>

</div>
<div class="data-pane" data-pane="original">
  
<pre>import tcod as libtcod

<span class="new-text">from game_states import GameStates


def handle_keys(key, game_state):
    if game_state == GameStates.PLAYERS_TURN:
        return handle_player_turn_keys(key)

    return {}</span>


def handle_player_turn_keys(key):
    ...</pre>

</div>

</div>


<p>N&rsquo;oubliez pas de modifier l&rsquo;appel à <code>handle_keys</code> dans <code>engine.py</code> :</p>

<div>
  <button class="btn btn-primary data-toggle-tab active" data-toggle-tab="diff">
    Diff
  </button>
  <button class="btn btn-secondary data-toggle-tab" data-toggle-tab="original">
    Original
  </button>

   <div class="data-pane active" data-pane="diff">
   <div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-diff" data-lang="diff"><span style="color:#f92672">-action = handle_keys(key)
</span><span style="color:#f92672"></span><span style="color:#a6e22e">+action = handle_keys(key, game_state)
</span></code></pre></div>

</div>
<div class="data-pane" data-pane="original">
  
<pre>action = handle_keys(key<span class="new-text">, game_state</span>)</pre>

</div>

</div>


<p>Avant de passer à la partie sur l&rsquo;inventaire, assurons nos arrières et ajoutons
un gestionnaire de touches pour la mort du joueur.</p>

<div>
  <button class="btn btn-primary data-toggle-tab active" data-toggle-tab="diff">
    Diff
  </button>
  <button class="btn btn-secondary data-toggle-tab" data-toggle-tab="original">
    Original
  </button>

   <div class="data-pane active" data-pane="diff">
   <div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-diff" data-lang="diff">...
def handle_keys(key, game_state):
    if game_state == GameStates.PLAYERS_TURN:
        return handle_player_turn_keys(key)
<span style="color:#a6e22e">+   elif game_state == GameStates.PLAYER_DEAD:
</span><span style="color:#a6e22e">+       return handle_player_dead_keys(key)
</span><span style="color:#a6e22e"></span>
    return {}


def handle_player_turn_keys(key):
    ...


<span style="color:#a6e22e">+def handle_player_dead_keys(key):
</span><span style="color:#a6e22e">+   key_char = chr(key.c)
</span><span style="color:#a6e22e">+
</span><span style="color:#a6e22e">+   if key_char == &#39;i&#39;:
</span><span style="color:#a6e22e">+       return {&#39;show_inventory&#39;: True}
</span><span style="color:#a6e22e">+
</span><span style="color:#a6e22e">+   if key.vk == libtcod.KEY_ENTER and key.lalt:
</span><span style="color:#a6e22e">+       # Alt+Enter: toggle full screen
</span><span style="color:#a6e22e">+       return {&#39;fullscreen&#39;: True}
</span><span style="color:#a6e22e">+   elif key.vk == libtcod.KEY_ESCAPE:
</span><span style="color:#a6e22e">+       # Exit the menu
</span><span style="color:#a6e22e">+       return {&#39;exit&#39;: True}
</span><span style="color:#a6e22e">+
</span><span style="color:#a6e22e">+   return {}
</span></code></pre></div>

</div>
<div class="data-pane" data-pane="original">
  
<pre>...
def handle_keys(key, game_state):
    if game_state == GameStates.PLAYERS_TURN:
        return handle_player_turn_keys(key)
    <span class="new-text">elif game_state == GameStates.PLAYER_DEAD:
        return handle_player_dead_keys(key)</span>

    return {}


def handle_player_turn_keys(key):
    ...


<span class="new-text">def handle_player_dead_keys(key):
    key_char = chr(key.c)

    if key_char == 'i':
        return {'show_inventory': True}

    if key.vk == libtcod.KEY_ENTER and key.lalt:
        # Alt+Enter: toggle full screen
        return {'fullscreen': True}
    elif key.vk == libtcod.KEY_ESCAPE:
        # Exit the menu
        return {'exit': True}

    return {}</span></pre>

</div>

</div>


<p>Maintenant crééons une nouvelle fonction, appelée <code>handle_inventory_keys</code> qui
va gérer nos saisies quand le menu d&rsquo;inventaire est ouvert.</p>

<div>
  <button class="btn btn-primary data-toggle-tab active" data-toggle-tab="diff">
    Diff
  </button>
  <button class="btn btn-secondary data-toggle-tab" data-toggle-tab="original">
    Original
  </button>

   <div class="data-pane active" data-pane="diff">
   <div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-diff" data-lang="diff">...
def handle_keys(key, game_state):
    if game_state == GameStates.PLAYERS_TURN:
        return handle_player_turn_keys(key)
    elif game_state == GameStates.PLAYER_DEAD:
        return handle_player_dead_keys(key)
<span style="color:#a6e22e">+   elif game_state == GameStates.SHOW_INVENTORY:
</span><span style="color:#a6e22e">+       return handle_inventory_keys(key)
</span><span style="color:#a6e22e"></span>
    return {}
...

<span style="color:#a6e22e">+def handle_inventory_keys(key):
</span><span style="color:#a6e22e">+   index = key.c - ord(&#39;a&#39;)
</span><span style="color:#a6e22e">+
</span><span style="color:#a6e22e">+   if index &gt;= 0:
</span><span style="color:#a6e22e">+       return {&#39;inventory_index&#39;: index}
</span><span style="color:#a6e22e">+
</span><span style="color:#a6e22e">+   if key.vk == libtcod.KEY_ENTER and key.lalt:
</span><span style="color:#a6e22e">+       # Alt+Enter: toggle full screen
</span><span style="color:#a6e22e">+       return {&#39;fullscreen&#39;: True}
</span><span style="color:#a6e22e">+   elif key.vk == libtcod.KEY_ESCAPE:
</span><span style="color:#a6e22e">+       # Exit the menu
</span><span style="color:#a6e22e">+       return {&#39;exit&#39;: True}
</span><span style="color:#a6e22e">+
</span><span style="color:#a6e22e">+   return {}
</span></code></pre></div>

</div>
<div class="data-pane" data-pane="original">
  
<pre>...
def handle_keys(key, game_state):
    if game_state == GameStates.PLAYERS_TURN:
        return handle_player_turn_keys(key)
    elif game_state == GameStates.PLAYER_DEAD:
        return handle_player_dead_keys(key)
    <span class="new-text">elif game_state == GameStates.SHOW_INVENTORY:
        return handle_inventory_keys(key)</span>

    return {}
...

<span class="new-text">def handle_inventory_keys(key):
    index = key.c - ord('a')

    if index >= 0:
        return {'inventory_index': index}

    if key.vk == libtcod.KEY_ENTER and key.lalt:
        # Alt+Enter: toggle full screen
        return {'fullscreen': True}
    elif key.vk == libtcod.KEY_ESCAPE:
        # Exit the menu
        return {'exit': True}

    return {}</span></pre>

</div>

</div>


<p>Qu&rsquo;est-ce que cette histoire avec la fonction <code>ord</code> ? Disons le simplement,
on converti la touche pressée en un indice. &lsquo;a&rsquo; sera 0, &lsquo;b&rsquo; sera 1 et ainsi de
suite. Cela nous permettra de choisir un item de l&rsquo;inventaire dans <code>engine.py</code>.
Tout ce que le gestionnaire de saisie doit faire est renvoyer l&rsquo;indice de ce
qui est ramassé. Il n&rsquo;a pas besoin de savoir quoi que ce soit de l&rsquo;objet
ni ce qui doit en être fait.</p>

<p>Ajoutons cet indice à <code>engin.py</code> et utilisons le !</p>

<div>
  <button class="btn btn-primary data-toggle-tab active" data-toggle-tab="diff">
    Diff
  </button>
  <button class="btn btn-secondary data-toggle-tab" data-toggle-tab="original">
    Original
  </button>

   <div class="data-pane active" data-pane="diff">
   <div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-diff" data-lang="diff">        ...
        show_inventory = action.get(&#39;show_inventory&#39;)
<span style="color:#a6e22e">+       inventory_index = action.get(&#39;inventory_index&#39;)
</span><span style="color:#a6e22e"></span>        exit = action.get(&#39;exit&#39;)
        ...
</code></pre></div>

</div>
<div class="data-pane" data-pane="original">
  
<pre>        ...
        show_inventory = action.get('show_inventory')
        <span class="new-text">inventory_index = action.get('inventory_index')</span>
        exit = action.get('exit')
        ...</pre>

</div>

</div>


<div>
  <button class="btn btn-primary data-toggle-tab active" data-toggle-tab="diff">
    Diff
  </button>
  <button class="btn btn-secondary data-toggle-tab" data-toggle-tab="original">
    Original
  </button>

   <div class="data-pane active" data-pane="diff">
   <div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-diff" data-lang="diff">        ...
        if show_inventory:
            ...

<span style="color:#a6e22e">+       if inventory_index is not None and previous_game_state != GameStates.PLAYER_DEAD and inventory_index &lt; len(
</span><span style="color:#a6e22e">+               player.inventory.items):
</span><span style="color:#a6e22e">+           item = player.inventory.items[inventory_index]
</span><span style="color:#a6e22e">+           print(item)
</span><span style="color:#a6e22e"></span>
        if exit:
            ...
</code></pre></div>

</div>
<div class="data-pane" data-pane="original">
  
<pre>        ...
        if show_inventory:
            ...

        <span class="new-text">if inventory_index is not None and previous_game_state != GameStates.PLAYER_DEAD and inventory_index < len(
                player.inventory.items):
            item = player.inventory.items[inventory_index]
            print(item)</span>

        if exit:
            ...</pre>

</div>

</div>


<p><em>*Remarque : l&rsquo;expression print n&rsquo;est là que pour l&rsquo;exemple. Nous avons presque
tout ce qu&rsquo;il faut pour utiliser l&rsquo;objet, je vous le promet !</em></p>

<p>Nous prenons l&rsquo;indice qui a été choisi et &ldquo;utilisons&rdquo; (seulement un print pour
l&rsquo;instant) l&rsquo;objet en question. Lancez le projet et vérifiez que cela
fonctionne. Maintenant qu&rsquo;on peut ouvrir le menu et choisir un objet, on peut
enfin passer à son utilisation.</p>

<p>Aussi, comment utiliser cet objet ? Le composant <code>Item</code> semble être un lieu
évident pour faire quelque chose. Mais chaque objet devrait faire quelque chose
de différent, n&rsquo;est ce pas ? Aussi la classe <code>Item</code> ne va pas contenir les
fonctoins pour soigner le joueur ou faire des dégâts à un ennemi. À la place
elle contiendra seulement les appels aux fonctions de soin et de dégâts ainsi
que les paramètres dont elles auront besoin. Ensuite nous enverrons les
résultats des ces fonctions (comme d&rsquo;habitude) et les exécuterons.</p>

<p>Modifiez <code>Item</code> ainsi :</p>

<div>
  <button class="btn btn-primary data-toggle-tab active" data-toggle-tab="diff">
    Diff
  </button>
  <button class="btn btn-secondary data-toggle-tab" data-toggle-tab="original">
    Original
  </button>

   <div class="data-pane active" data-pane="diff">
   <div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-diff" data-lang="diff">class Item:
<span style="color:#f92672">-   def __init__(self):
</span><span style="color:#f92672"></span><span style="color:#a6e22e">+   def __init__(self, use_function=None, **kwargs):
</span><span style="color:#a6e22e"></span><span style="color:#f92672">-       pass
</span><span style="color:#f92672"></span><span style="color:#a6e22e">+       self.use_function = use_function
</span><span style="color:#a6e22e">+       self.function_kwargs = kwargs
</span></code></pre></div>

</div>
<div class="data-pane" data-pane="original">
  
<pre>class Item:
    def __init__(self<span class="new-text">, use_function=None, **kwargs</span>):
        <span class="crossed-out-text">pass</span>
        <span class="new-text">self.use_function = use_function
        self.function_kwargs = kwargs</span></pre>

</div>

</div>


<p>Et que dire des fonctions elles mêmes ? Définissons les séparément, cela
nous permettra (dans le chapitre suivant) d&rsquo;attribuer librement des fonctions
au paramètre <code>use_function</code>. Ainsi nous adapterons le comportement en fonction
de l&rsquo;item selon nos besoins.</p>

<p>Créez un fichier, appelé <code>item_functions.py</code> et ajoutez-y la fonction suivante :</p>

<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-py3" data-lang="py3"><span style="color:#f92672">import</span> tcod <span style="color:#66d9ef">as</span> libtcod

<span style="color:#f92672">from</span> game_messages <span style="color:#66d9ef">import</span> Message


<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">heal</span>(<span style="color:#f92672">*</span>args, <span style="color:#f92672">**</span>kwargs):
    entity <span style="color:#f92672">=</span> args[<span style="color:#ae81ff">0</span>]
    amount <span style="color:#f92672">=</span> kwargs<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#39;amount&#39;</span>)

    results <span style="color:#f92672">=</span> []

    <span style="color:#66d9ef">if</span> entity<span style="color:#f92672">.</span>fighter<span style="color:#f92672">.</span>hp <span style="color:#f92672">==</span> entity<span style="color:#f92672">.</span>fighter<span style="color:#f92672">.</span>max_hp:
        results<span style="color:#f92672">.</span>append({<span style="color:#e6db74">&#39;consumed&#39;</span>: <span style="color:#66d9ef">False</span>, <span style="color:#e6db74">&#39;message&#39;</span>: Message(<span style="color:#e6db74">&#39;You are already at full health&#39;</span>, libtcod<span style="color:#f92672">.</span>yellow)})
    <span style="color:#66d9ef">else</span>:
        entity<span style="color:#f92672">.</span>fighter<span style="color:#f92672">.</span>heal(amount)
        results<span style="color:#f92672">.</span>append({<span style="color:#e6db74">&#39;consumed&#39;</span>: <span style="color:#66d9ef">True</span>, <span style="color:#e6db74">&#39;message&#39;</span>: Message(<span style="color:#e6db74">&#39;Your wounds start to feel better!&#39;</span>, libtcod<span style="color:#f92672">.</span>green)})

    <span style="color:#66d9ef">return</span> results</code></pre></div>

<p>Nous prenons l&rsquo;entité qui utilise l&rsquo;item comme premier argument (toutes nos
fonctions le feront, même si elles n&rsquo;en ont pas besoin). Nous extrayons aussi
le nombre (&ldquo;amount&rdquo;) des &ldquo;kwargs&rdquo; ce qui sera fourni par le <code>function_kwargs</code>
du composant <code>Item</code>.</p>

<p>Nous devons ajouter la méthode <code>heal</code> au composant <code>Fighter</code> pour que cela
fonctionne (remarque : les deux fonctions sont appelées &ldquo;heal&rdquo; mais elles
sont différentes).</p>

<div>
  <button class="btn btn-primary data-toggle-tab active" data-toggle-tab="diff">
    Diff
  </button>
  <button class="btn btn-secondary data-toggle-tab" data-toggle-tab="original">
    Original
  </button>

   <div class="data-pane active" data-pane="diff">
   <div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-diff" data-lang="diff">    ...
    def take_damage(self, amount):
        ...

<span style="color:#a6e22e">+   def heal(self, amount):
</span><span style="color:#a6e22e">+       self.hp += amount
</span><span style="color:#a6e22e">+
</span><span style="color:#a6e22e">+       if self.hp &gt; self.max_hp:
</span><span style="color:#a6e22e">+           self.hp = self.max_hp
</span><span style="color:#a6e22e"></span>
    def attack(self, target):
        ...
</code></pre></div>

</div>
<div class="data-pane" data-pane="original">
  
<pre>    ...
    def take_damage(self, amount):
        ...

    <span class="new-text">def heal(self, amount):
        self.hp += amount

        if self.hp > self.max_hp:
            self.hp = self.max_hp</span>

    def attack(self, target):
        ...</pre>

</div>

</div>


<p>Cela prendra plus de sens une fois qu&rsquo;on aura passé la fonction <code>heal</code> aux
potions de soin. Faisons le maintenant : dans la fonction <code>place_entities</code> de
<code>game_map</code> :</p>

<div>
  <button class="btn btn-primary data-toggle-tab active" data-toggle-tab="diff">
    Diff
  </button>
  <button class="btn btn-secondary data-toggle-tab" data-toggle-tab="original">
    Original
  </button>

   <div class="data-pane active" data-pane="diff">
   <div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-diff" data-lang="diff">            ...
            if not any([entity for entity in entities if entity.x == x and entity.y == y]):
<span style="color:#f92672">-               item_component = Item()
</span><span style="color:#f92672"></span><span style="color:#a6e22e">+               item_component = Item(use_function=heal, amount=4)
</span><span style="color:#a6e22e"></span>                item = Entity(x, y, &#39;!&#39;, libtcod.violet, &#39;Healing Potion&#39;, render_order=RenderOrder.ITEM,
                              item=item_component)
</code></pre></div>

</div>
<div class="data-pane" data-pane="original">
  
<pre>            ...
            if not any([entity for entity in entities if entity.x == x and entity.y == y]):
                <span class="crossed-out-text">item_component = Item()</span>
                <span class="new-text">item_component = Item(use_function=heal, amount=4)</span>
                item = Entity(x, y, '!', libtcod.violet, 'Healing Potion', render_order=RenderOrder.ITEM,
                              item=item_component)</pre>

</div>

</div>


<p>Vous devez importer <code>heal</code> pour cela.</p>

<div>
  <button class="btn btn-primary data-toggle-tab active" data-toggle-tab="diff">
    Diff
  </button>
  <button class="btn btn-secondary data-toggle-tab" data-toggle-tab="original">
    Original
  </button>

   <div class="data-pane active" data-pane="diff">
   <div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-diff" data-lang="diff">...
from entity import Entity

<span style="color:#a6e22e">+from item_functions import heal
</span><span style="color:#a6e22e"></span>
from map_objects.rectangle import Rect
...
</code></pre></div>

</div>
<div class="data-pane" data-pane="original">
  
<pre>...
from entity import Entity

<span class="new-text">from item_functions import heal</span>

from map_objects.rectangle import Rect
...</pre>

</div>

</div>


<p>Maintenant notre item dispose d&rsquo;une fonction à exécuter quand il est employé.
Mais <em>où</em> cela doit-il être appelé ? Pourquoi notre inventaire n&rsquo;appellerait-il
pas la fonction ? Ajoutez la fonction suivante à <code>Inventory</code> :</p>

<div>
  <button class="btn btn-primary data-toggle-tab active" data-toggle-tab="diff">
    Diff
  </button>
  <button class="btn btn-secondary data-toggle-tab" data-toggle-tab="original">
    Original
  </button>

   <div class="data-pane active" data-pane="diff">
   <div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-diff" data-lang="diff">    ...
<span style="color:#a6e22e">+   def use(self, item_entity, **kwargs):
</span><span style="color:#a6e22e">+       results = []
</span><span style="color:#a6e22e">+
</span><span style="color:#a6e22e">+       item_component = item_entity.item
</span><span style="color:#a6e22e">+
</span><span style="color:#a6e22e">+       if item_component.use_function is None:
</span><span style="color:#a6e22e">+           results.append({&#39;message&#39;: Message(&#39;The {0} cannot be used&#39;.format(item_entity.name), libtcod.yellow)})
</span><span style="color:#a6e22e">+       else:
</span><span style="color:#a6e22e">+           kwargs = {**item_component.function_kwargs, **kwargs}
</span><span style="color:#a6e22e">+           item_use_results = item_component.use_function(self.owner, **kwargs)
</span><span style="color:#a6e22e">+
</span><span style="color:#a6e22e">+           for item_use_result in item_use_results:
</span><span style="color:#a6e22e">+               if item_use_result.get(&#39;consumed&#39;):
</span><span style="color:#a6e22e">+                   self.remove_item(item_entity)
</span><span style="color:#a6e22e">+
</span><span style="color:#a6e22e">+           results.extend(item_use_results)
</span><span style="color:#a6e22e">+
</span><span style="color:#a6e22e">+       return results
</span><span style="color:#a6e22e">+
</span><span style="color:#a6e22e">+   def remove_item(self, item):
</span><span style="color:#a6e22e">+       self.items.remove(item)
</span></code></pre></div>

</div>
<div class="data-pane" data-pane="original">
  
<pre>    ...
    <span class="new-text">def use(self, item_entity, **kwargs):
        results = []

        item_component = item_entity.item

        if item_component.use_function is None:
            results.append({'message': Message('The {0} cannot be used'.format(item_entity.name), libtcod.yellow)})
        else:
            kwargs = {**item_component.function_kwargs, **kwargs}
            item_use_results = item_component.use_function(self.owner, **kwargs)

            for item_use_result in item_use_results:
                if item_use_result.get('consumed'):
                    self.remove_item(item_entity)

            results.extend(item_use_results)

        return results

    def remove_item(self, item):
        self.items.remove(item)</span></pre>

</div>

</div>


<div>
  <button class="btn btn-primary data-toggle-tab active" data-toggle-tab="diff">
    Diff
  </button>
  <button class="btn btn-secondary data-toggle-tab" data-toggle-tab="original">
    Original
  </button>

   <div class="data-pane active" data-pane="diff">
   <div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-diff" data-lang="diff">        ...
        if inventory_index is not None and previous_game_state != GameStates.PLAYER_DEAD and inventory_index &lt; len(
                player.inventory.items):
            item = player.inventory.items[inventory_index]
<span style="color:#f92672">-           print(item)
</span><span style="color:#f92672"></span><span style="color:#a6e22e">+           player_turn_results.extend(player.inventory.use(item))
</span></code></pre></div>

</div>
<div class="data-pane" data-pane="original">
  
<pre>        ...
        if inventory_index is not None and previous_game_state != GameStates.PLAYER_DEAD and inventory_index < len(
                player.inventory.items):
            item = player.inventory.items[inventory_index]
            <span class="crossed-out-text">print(item)</span>
            <span class="new-text">player_turn_results.extend(player.inventory.use(item))</span></pre>

</div>

</div>


<p>Finally, let&rsquo;s handle the results of the item use function in
<code>engine.py</code>:</p>

<div>
  <button class="btn btn-primary data-toggle-tab active" data-toggle-tab="diff">
    Diff
  </button>
  <button class="btn btn-secondary data-toggle-tab" data-toggle-tab="original">
    Original
  </button>

   <div class="data-pane active" data-pane="diff">
   <div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-diff" data-lang="diff">        ...
        for player_turn_result in player_turn_results:
            message = player_turn_result.get(&#39;message&#39;)
            dead_entity = player_turn_result.get(&#39;dead&#39;)
            item_added = player_turn_result.get(&#39;item_added&#39;)
<span style="color:#a6e22e">+           item_consumed = player_turn_result.get(&#39;consumed&#39;)
</span><span style="color:#a6e22e"></span>            ...
            if item_added:
                entities.remove(item_added)

                game_state = GameStates.ENEMY_TURN

<span style="color:#a6e22e">+           if item_consumed:
</span><span style="color:#a6e22e">+               game_state = GameStates.ENEMY_TURN
</span><span style="color:#a6e22e"></span>            ...
</code></pre></div>

</div>
<div class="data-pane" data-pane="original">
  
<pre>        ...
        for player_turn_result in player_turn_results:
            message = player_turn_result.get('message')
            dead_entity = player_turn_result.get('dead')
            item_added = player_turn_result.get('item_added')
            <span class="new-text">item_consumed = player_turn_result.get('consumed')</span>
            ...
            if item_added:
                entities.remove(item_added)

                game_state = GameStates.ENEMY_TURN

            <span class="new-text">if item_consumed:
                game_state = GameStates.ENEMY_TURN</span>
            ...</pre>

</div>

</div>


<p>Lancez le projet maintenant. Vous pouvez consommer les potions de soin et cela
va utiliser un tour. Les potions ne seront pas dépensées si vous êtes déjà
au maximum de santé.</p>

<p>Une dernière étape avant de clore ce chapitre : abandonner (drop) un objet. Cela
peut semble inutile mais plus tard, quand nous aurons de nombreux niveaux dans
le donjon, le joueur devra prendre des décisions concernant les objets à
conserver et abandonner.</p>

<p>D&rsquo;abord ajoutons un nouvel état au jeu :</p>

<div>
  <button class="btn btn-primary data-toggle-tab active" data-toggle-tab="diff">
    Diff
  </button>
  <button class="btn btn-secondary data-toggle-tab" data-toggle-tab="original">
    Original
  </button>

   <div class="data-pane active" data-pane="diff">
   <div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-diff" data-lang="diff">class GameStates(Enum):
    PLAYERS_TURN = 1
    ENEMY_TURN = 2
    PLAYER_DEAD = 3
    SHOW_INVENTORY = 4
<span style="color:#a6e22e">+   DROP_INVENTORY = 5
</span></code></pre></div>

</div>
<div class="data-pane" data-pane="original">
  
<pre>class GameStates(Enum):
    PLAYERS_TURN = 1
    ENEMY_TURN = 2
    PLAYER_DEAD = 3
    SHOW_INVENTORY = 4
    <span class="new-text">DROP_INVENTORY = 5</span></pre>

</div>

</div>


<p>Ensuite modifier <code>handle_player_turn_keys</code> pour réagir à la touche &rsquo;d&rsquo; :</p>

<div>
  <button class="btn btn-primary data-toggle-tab active" data-toggle-tab="diff">
    Diff
  </button>
  <button class="btn btn-secondary data-toggle-tab" data-toggle-tab="original">
    Original
  </button>

   <div class="data-pane active" data-pane="diff">
   <div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-diff" data-lang="diff">    ...
    elif key_char == &#39;i&#39;:
        return {&#39;show_inventory&#39;: True}

<span style="color:#a6e22e">+   elif key_char == &#39;d&#39;:
</span><span style="color:#a6e22e">+       return {&#39;drop_inventory&#39;: True}
</span><span style="color:#a6e22e"></span>
    if key.vk == libtcod.KEY_ENTER and key.lalt:
        ...
</code></pre></div>

</div>
<div class="data-pane" data-pane="original">
  
<pre>    ...
    elif key_char == 'i':
        return {'show_inventory': True}

    <span class="new-text">elif key_char == 'd':
        return {'drop_inventory': True}</span>

    if key.vk == libtcod.KEY_ENTER and key.lalt:
        ...</pre>

</div>

</div>


<p>Mettez à jour le gestionnaire d&rsquo;action pour en tenir compte :</p>

<div>
  <button class="btn btn-primary data-toggle-tab active" data-toggle-tab="diff">
    Diff
  </button>
  <button class="btn btn-secondary data-toggle-tab" data-toggle-tab="original">
    Original
  </button>

   <div class="data-pane active" data-pane="diff">
   <div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-diff" data-lang="diff">        ...
        show_inventory = action.get(&#39;show_inventory&#39;)
<span style="color:#a6e22e">+       drop_inventory = action.get(&#39;drop_inventory&#39;)
</span><span style="color:#a6e22e"></span>        inventory_index = action.get(&#39;inventory_index&#39;)
        ...
</code></pre></div>

</div>
<div class="data-pane" data-pane="original">
  
<pre>        ...
        show_inventory = action.get('show_inventory')
        <span class="new-text">drop_inventory = action.get('drop_inventory')</span>
        inventory_index = action.get('inventory_index')
        ...</pre>

</div>

</div>


<p>Nous devrons changer l&rsquo;état du jeu quand un joueur presse cette touche :</p>

<div>
  <button class="btn btn-primary data-toggle-tab active" data-toggle-tab="diff">
    Diff
  </button>
  <button class="btn btn-secondary data-toggle-tab" data-toggle-tab="original">
    Original
  </button>

   <div class="data-pane active" data-pane="diff">
   <div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-diff" data-lang="diff">        ...
        if show_inventory:
            previous_game_state = game_state
            game_state = GameStates.SHOW_INVENTORY

<span style="color:#a6e22e">+       if drop_inventory:
</span><span style="color:#a6e22e">+           previous_game_state = game_state
</span><span style="color:#a6e22e">+           game_state = GameStates.DROP_INVENTORY
</span><span style="color:#a6e22e"></span>
        if inventory_index is not None and previous_game_state != GameStates.PLAYER_DEAD and inventory_index &lt; len(
                player.inventory.items):
            ...
</code></pre></div>

</div>
<div class="data-pane" data-pane="original">
  
<pre>        ...
        if show_inventory:
            previous_game_state = game_state
            game_state = GameStates.SHOW_INVENTORY

        <span class="new-text">if drop_inventory:
            previous_game_state = game_state
            game_state = GameStates.DROP_INVENTORY</span>

        if inventory_index is not None and previous_game_state != GameStates.PLAYER_DEAD and inventory_index < len(
                player.inventory.items):
            ...</pre>

</div>

</div>


<p>Vous pouvez croire qu&rsquo;on doive ajouter une autre fonction pour gérer cette
touche mais ce n&rsquo;est pas le cas. Nous allons simplement utiliser le code de
<code>SHOW_INVENTORY</code> dans ce but. Modifiez simplement le bloc &ldquo;if&rdquo; dans
<code>handle_keys</code> :</p>

<div>
  <button class="btn btn-primary data-toggle-tab active" data-toggle-tab="diff">
    Diff
  </button>
  <button class="btn btn-secondary data-toggle-tab" data-toggle-tab="original">
    Original
  </button>

   <div class="data-pane active" data-pane="diff">
   <div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-diff" data-lang="diff">def handle_keys(key, game_state):
    if game_state == GameStates.PLAYERS_TURN:
        return handle_player_turn_keys(key)
    elif game_state == GameStates.PLAYER_DEAD:
        return handle_player_dead_keys(key)
<span style="color:#f92672">-   elif game_state == GameStates.SHOW_INVENTORY:
</span><span style="color:#f92672"></span><span style="color:#a6e22e">+   elif game_state in (GameStates.SHOW_INVENTORY, GameStates.DROP_INVENTORY):
</span><span style="color:#a6e22e"></span>        return handle_inventory_keys(key)

    return {}
</code></pre></div>

</div>
<div class="data-pane" data-pane="original">
  
<pre>def handle_keys(key, game_state):
    if game_state == GameStates.PLAYERS_TURN:
        return handle_player_turn_keys(key)
    elif game_state == GameStates.PLAYER_DEAD:
        return handle_player_dead_keys(key)
    <span class="crossed-out-text">elif game_state == GameStates.SHOW_INVENTORY:</span>
    <span class="new-text">elif game_state in (GameStates.SHOW_INVENTORY, GameStates.DROP_INVENTORY):</span>
        return handle_inventory_keys(key)

    return {}</pre>

</div>

</div>


<p>Aussi, changez la partie <code>exit</code> :</p>

<div>
  <button class="btn btn-primary data-toggle-tab active" data-toggle-tab="diff">
    Diff
  </button>
  <button class="btn btn-secondary data-toggle-tab" data-toggle-tab="original">
    Original
  </button>

   <div class="data-pane active" data-pane="diff">
   <div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-diff" data-lang="diff">        ...
        if exit:
<span style="color:#f92672">-           if game_state in GameStates.SHOW_INVENTORY:
</span><span style="color:#f92672"></span><span style="color:#a6e22e">+           if game_state in (GameStates.SHOW_INVENTORY, GameStates.DROP_INVENTORY):
</span><span style="color:#a6e22e"></span>                game_state = previous_game_state
            else:
                return True
        ...
</code></pre></div>

</div>
<div class="data-pane" data-pane="original">
  
<pre>        ...
        if exit:
            <span class="crossed-out-text">if game_state in GameStates.SHOW_INVENTORY:</span>
            <span class="new-text">if game_state in (GameStates.SHOW_INVENTORY, GameStates.DROP_INVENTORY):</span>
                game_state = previous_game_state
            else:
                return True
        ...</pre>

</div>

</div>


<p>Et maintenant l&rsquo;affichage du menu &ldquo;drop&rdquo; (déposer). Cela ne change pas vraiment
du menu d&rsquo;inventaire aussi nous pouvons employer la même fonction et lui
donner un autre titre.</p>

<div>
  <button class="btn btn-primary data-toggle-tab active" data-toggle-tab="diff">
    Diff
  </button>
  <button class="btn btn-secondary data-toggle-tab" data-toggle-tab="original">
    Original
  </button>

   <div class="data-pane active" data-pane="diff">
   <div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-diff" data-lang="diff">    ...
<span style="color:#f92672">-   if game_state == GameStates.SHOW_INVENTORY:
</span><span style="color:#f92672">-       inventory_menu(con, &#39;Press the key next to an item to use it, or Esc to cancel.\n&#39;,
</span><span style="color:#f92672">-                      player.inventory, 50, screen_width, screen_height)
</span><span style="color:#f92672"></span>
<span style="color:#a6e22e">+   if game_state in (GameStates.SHOW_INVENTORY, GameStates.DROP_INVENTORY):
</span><span style="color:#a6e22e">+       if game_state == GameStates.SHOW_INVENTORY:
</span><span style="color:#a6e22e">+           inventory_title = &#39;Press the key next to an item to use it, or Esc to cancel.\n&#39;
</span><span style="color:#a6e22e">+       else:
</span><span style="color:#a6e22e">+           inventory_title = &#39;Press the key next to an item to drop it, or Esc to cancel.\n&#39;
</span><span style="color:#a6e22e">+
</span><span style="color:#a6e22e">+       inventory_menu(con, inventory_title, player.inventory, 50, screen_width, screen_height)
</span></code></pre></div>

</div>
<div class="data-pane" data-pane="original">
  
<pre>    ...
    <span class="crossed-out-text">if game_state == GameStates.SHOW_INVENTORY:</span>
        <span class="crossed-out-text">inventory_menu(con, 'Press the key next to an item to use it, or Esc to cancel.\n',</span>
                       <span class="crossed-out-text">player.inventory, 50, screen_width, screen_height)</span>

    <span class="new-text">if game_state in (GameStates.SHOW_INVENTORY, GameStates.DROP_INVENTORY):
        if game_state == GameStates.SHOW_INVENTORY:
            inventory_title = 'Press the key next to an item to use it, or Esc to cancel.\n'
        else:
            inventory_title = 'Press the key next to an item to drop it, or Esc to cancel.\n'

        inventory_menu(con, inventory_title, player.inventory, 50, screen_width, screen_height)</span></pre>

</div>

</div>


<p>Que se passe-t-il quand le joueur presse une touche de ce menu ? Modifions la
partie dans <code>engine.py</code> qui gère la partie <code>inventory_index</code> pour tenir compte
de l&rsquo;état du jeu. Si l&rsquo;état est sur <code>SHOW_INVENTORY</code>, alors on utilise l&rsquo;objet,
et s&rsquo;il est sur <code>DROP_INVENTORY</code> alors on appelle une fonction qui lâche
l&rsquo;objet.</p>

<div>
  <button class="btn btn-primary data-toggle-tab active" data-toggle-tab="diff">
    Diff
  </button>
  <button class="btn btn-secondary data-toggle-tab" data-toggle-tab="original">
    Original
  </button>

   <div class="data-pane active" data-pane="diff">
   <div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-diff" data-lang="diff">if inventory_index is not None and previous_game_state != GameStates.PLAYER_DEAD and inventory_index &lt; len(
                player.inventory.items):
            item = player.inventory.items[inventory_index]

<span style="color:#f92672">-           player_turn_results.extend(player.inventory.use(item))
</span><span style="color:#f92672"></span>
<span style="color:#a6e22e">+           if game_state == GameStates.SHOW_INVENTORY:
</span><span style="color:#a6e22e"></span>                player_turn_results.extend(player.inventory.use(item))
<span style="color:#a6e22e">+           elif game_state == GameStates.DROP_INVENTORY:
</span><span style="color:#a6e22e">+               player_turn_results.extend(player.inventory.drop_item(item))
</span></code></pre></div>

</div>
<div class="data-pane" data-pane="original">
  
<pre>if inventory_index is not None and previous_game_state != GameStates.PLAYER_DEAD and inventory_index < len(
                player.inventory.items):
            item = player.inventory.items[inventory_index]

            <span class="new-text">if game_state == GameStates.SHOW_INVENTORY:</span>
                <span style="color: blue">player_turn_results.extend(player.inventory.use(item))</span>
            <span class="new-text">elif game_state == GameStates.DROP_INVENTORY:
                player_turn_results.extend(player.inventory.drop_item(item))</span></pre>

</div>

</div>


<p>Nous n&rsquo;avons pas défini la méthode <code>drop_item</code> de l&rsquo;inventaire pour l&rsquo;instant
aussi faisons le maintenant. Cela va retirer l&rsquo;objet de l&rsquo;inventaire, établir
les coordonnées de l&rsquo;objet sur celle du joueur (car l&rsquo;objet est déposé aux
pieds du joueur) et renvoyer le résultat.</p>

<div>
  <button class="btn btn-primary data-toggle-tab active" data-toggle-tab="diff">
    Diff
  </button>
  <button class="btn btn-secondary data-toggle-tab" data-toggle-tab="original">
    Original
  </button>

   <div class="data-pane active" data-pane="diff">
   <div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-diff" data-lang="diff">    ...
    def remove_item(self, item):
        self.items.remove(item)

<span style="color:#a6e22e">+   def drop_item(self, item):
</span><span style="color:#a6e22e">+       results = []
</span><span style="color:#a6e22e">+
</span><span style="color:#a6e22e">+       item.x = self.owner.x
</span><span style="color:#a6e22e">+       item.y = self.owner.y
</span><span style="color:#a6e22e">+
</span><span style="color:#a6e22e">+       self.remove_item(item)
</span><span style="color:#a6e22e">+       results.append({&#39;item_dropped&#39;: item, &#39;message&#39;: Message(&#39;You dropped the {0}&#39;.format(item.name),
</span><span style="color:#a6e22e">+                                                                libtcod.yellow)})
</span><span style="color:#a6e22e">+
</span><span style="color:#a6e22e">+       return results
</span></code></pre></div>

</div>
<div class="data-pane" data-pane="original">
  
<pre>    ...
    def remove_item(self, item):
        self.items.remove(item)

    <span class="new-text">def drop_item(self, item):
        results = []

        item.x = self.owner.x
        item.y = self.owner.y

        self.remove_item(item)
        results.append({'item_dropped': item, 'message': Message('You dropped the {0}'.format(item.name),
                                                                 libtcod.yellow)})

        return results</span></pre>

</div>

</div>


<p>Enfin, gérer les résultats dans <code>engine.py</code> :</p>

<div>
  <button class="btn btn-primary data-toggle-tab active" data-toggle-tab="diff">
    Diff
  </button>
  <button class="btn btn-secondary data-toggle-tab" data-toggle-tab="original">
    Original
  </button>

   <div class="data-pane active" data-pane="diff">
   <div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-diff" data-lang="diff">        ...
        for player_turn_result in player_turn_results:
            message = player_turn_result.get(&#39;message&#39;)
            dead_entity = player_turn_result.get(&#39;dead&#39;)
            item_added = player_turn_result.get(&#39;item_added&#39;)
            item_consumed = player_turn_result.get(&#39;consumed&#39;)
<span style="color:#a6e22e">+           item_dropped = player_turn_result.get(&#39;item_dropped&#39;)
</span><span style="color:#a6e22e"></span>            ...
            if item_consumed:
                game_state = GameStates.ENEMY_TURN

<span style="color:#a6e22e">+           if item_dropped:
</span><span style="color:#a6e22e">+               entities.append(item_dropped)
</span><span style="color:#a6e22e">+
</span><span style="color:#a6e22e">+               game_state = GameStates.ENEMY_TURN
</span></code></pre></div>

</div>
<div class="data-pane" data-pane="original">
  
<pre>        ...
        for player_turn_result in player_turn_results:
            message = player_turn_result.get('message')
            dead_entity = player_turn_result.get('dead')
            item_added = player_turn_result.get('item_added')
            item_consumed = player_turn_result.get('consumed')
            <span class="new-text">item_dropped = player_turn_result.get('item_dropped')</span>
            ...
            if item_consumed:
                game_state = GameStates.ENEMY_TURN

            <span class="new-text">if item_dropped:
                entities.append(item_dropped)

                game_state = GameStates.ENEMY_TURN</span></pre>

</div>

</div>


<p>Quel chapitre ! Cela a demandé beaucoup de réglages pour utiliser les objets
mais nous disposons d&rsquo;un cadre sur lequel bâtir. C&rsquo;est ce que nous ferons
dans le chapitre suivant en ajoutant divers parchemins pour lancer des sorts
à nos ennemis.</p>

<p>Si vous voulez voir le code actuel entièrement, <a href="https://github.com/TStand90/roguelike_tutorial_revised/tree/part8">cliquez ici</a>.</p>

<p><a href="/tutorials/tcod/part-9">Cliquez ici pour vous rendre à la partie suivante de ce tutoriel.</a></p>

<script src="/js/codetabs.js"></script>


    

    


</article>



        </div>

        <aside class="col-12 col-lg-3 ml-auto blog-sidebar">
    
    
        <section>
    
        
    
        
    
</section>
    
</aside>

      </div>
    </div>
    

    
      







<footer class="blog-footer w-100">
    <nav class="navbar navbar-light bg-light">
        <p class="w-100 text-center">Dernière mise à jour le 24 juillet 2019</p>
        <p class="w-100 text-center"><a href="#">Back to top</a></p>
    </nav>
</footer>

    

    
    
    <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js" integrity="sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49" crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js" integrity="sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy" crossorigin="anonymous"></script>
  </body>
</html>
